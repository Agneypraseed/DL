<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Convolutional neural networks for artistic style transfer — Harish Narayanan</title>
    <meta name="description" content="There’s an amazing app out right now called Prisma that transforms your photos into works of art using the styles of famous artwork and motifs. The app performs this style transfer with the help of a branch of machine learning called convolutional neural networks. In this article we’re going to take a journey through the world of convolutional neural networks from theory to practice, as we systematically reproduce Prisma’s core visual effect.">
    <meta name="author" content="Harish Narayanan">

    <link rel="manifest" href="https://harishnarayanan.org/site.webmanifest">
    <link rel="apple-touch-icon" href="https://harishnarayanan.org/icon.png">
    <link rel="stylesheet" href="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/normalize.css">
    <link rel="stylesheet" href="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/main.css">
    <link rel="stylesheet" href="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/highlight.css">
  <style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1px; bottom: 2px; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><style type="text/css">.MathJax_Display {text-align: center; margin: 1em 0em; position: relative; display: block!important; text-indent: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; width: 100%}
.MathJax .merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MathJax .MJX-monospace {font-family: monospace}
.MathJax .MJX-sans-serif {font-family: sans-serif}
#MathJax_Tooltip {background-color: InfoBackground; color: InfoText; border: 1px solid black; box-shadow: 2px 2px 5px #AAAAAA; -webkit-box-shadow: 2px 2px 5px #AAAAAA; -moz-box-shadow: 2px 2px 5px #AAAAAA; -khtml-box-shadow: 2px 2px 5px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true'); padding: 3px 4px; z-index: 401; position: absolute; left: 0; top: 0; width: auto; height: auto; display: none}
.MathJax {display: inline; font-style: normal; font-weight: normal; line-height: normal; font-size: 100%; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0; min-height: 0; border: 0; padding: 0; margin: 0}
.MathJax:focus, body :focus .MathJax {display: inline-table}
.MathJax.MathJax_FullWidth {text-align: center; display: table-cell!important; width: 10000em!important}
.MathJax img, .MathJax nobr, .MathJax a {border: 0; padding: 0; margin: 0; max-width: none; max-height: none; min-width: 0; min-height: 0; vertical-align: 0; line-height: normal; text-decoration: none}
img.MathJax_strut {border: 0!important; padding: 0!important; margin: 0!important; vertical-align: 0!important}
.MathJax span {display: inline; position: static; border: 0; padding: 0; margin: 0; vertical-align: 0; line-height: normal; text-decoration: none}
.MathJax nobr {white-space: nowrap!important}
.MathJax img {display: inline!important; float: none!important}
.MathJax * {transition: none; -webkit-transition: none; -moz-transition: none; -ms-transition: none; -o-transition: none}
.MathJax_Processing {visibility: hidden; position: fixed; width: 0; height: 0; overflow: hidden}
.MathJax_Processed {display: none!important}
.MathJax_ExBox {display: block!important; overflow: hidden; width: 1px; height: 60ex; min-height: 0; max-height: none}
.MathJax .MathJax_EmBox {display: block!important; overflow: hidden; width: 1px; height: 60em; min-height: 0; max-height: none}
.MathJax_LineBox {display: table!important}
.MathJax_LineBox span {display: table-cell!important; width: 10000em!important; min-width: 0; max-width: none; padding: 0; border: 0; margin: 0}
.MathJax .MathJax_HitBox {cursor: text; background: white; opacity: 0; filter: alpha(opacity=0)}
.MathJax .MathJax_HitBox * {filter: none; opacity: 1; background: transparent}
#MathJax_Tooltip * {filter: none; opacity: 1; background: transparent}
@font-face {font-family: MathJax_Main; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Main-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Main-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Main; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Main-Bold.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Main-Bold.otf?V=2.7.1') format('opentype'); font-weight: bold}
@font-face {font-family: MathJax_Main; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Main-Italic.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Main-Italic.otf?V=2.7.1') format('opentype'); font-style: italic}
@font-face {font-family: MathJax_Math; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Math-Italic.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Math-Italic.otf?V=2.7.1') format('opentype'); font-style: italic}
@font-face {font-family: MathJax_Caligraphic; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Caligraphic-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Caligraphic-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size1; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size1-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size1-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size2; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size2-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size2-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size3; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size3-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size3-Regular.otf?V=2.7.1') format('opentype')}
@font-face {font-family: MathJax_Size4; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_Size4-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_Size4-Regular.otf?V=2.7.1') format('opentype')}
.MathJax .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><style type="text/css">@font-face {font-family: MathJax_AMS; src: url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/woff/MathJax_AMS-Regular.woff?V=2.7.1') format('woff'), url('https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/fonts/HTML-CSS/TeX/otf/MathJax_AMS-Regular.otf?V=2.7.1') format('opentype')}
</style></head>

  <body><div style="visibility: hidden; overflow: hidden; position: absolute; top: 0px; height: 1px; width: auto; padding: 0px; border: 0px none; margin: 0px; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal;"><div id="MathJax_Hidden"></div></div><div id="MathJax_Message" style="display: none;"></div>

    <header>
      <nav class="navbar">
        <div class="container">
          <ul class="navbar-list">
            <li class="navbar-item"><a class="navbar-link" href="https://harishnarayanan.org/">About</a></li>
            <li class="navbar-item"><a class="navbar-link" href="https://harishnarayanan.org/writing/">Writing</a></li>
            <li class="navbar-item"><a class="navbar-link" href="https://harishnarayanan.org/projects/">Projects</a></li>
            <li class="navbar-item"><a class="navbar-link" href="https://harishnarayanan.org/research/">Research</a></li>
            <li class="navbar-item"><a class="navbar-link" href="https://harishnarayanan.org/photos/">Photos</a></li>
          </ul>
        </div>
      </nav>
    </header>

    <main>

<div class="container">
<article class="">

  <header class="post-header">
    <h1 class="post-title">Convolutional neural networks for artistic style transfer</h1>
    
      
      
      
      
      
      
      
      
      
      
      
    <section class="post-meta">
      <time class="post-date" datetime="2017-03-31T21:00:00+01:00">31 Mar 2017</time> — 52 min read
    </section>
  </header>

  <section class="post-content">
    

<p>There’s an amazing app out right now called <a href="https://prisma-ai.com/">Prisma</a> that
transforms your photos into works of art using the styles of famous
artwork and motifs. The app performs this style transfer with the help
of a branch of machine learning called <a href="https://en.wikipedia.org/wiki/Convolutional_neural_network">convolutional neural
networks</a>. In this article we’re going to take a journey
through the world of convolutional neural networks from theory to
practice, as we systematically reproduce Prisma’s core visual effect.</p>

<h2 id="so-what-is-prisma-and-how-might-it-work">So what is Prisma and how might it work?</h2>

<p>Prisma is a mobile app that allows you to transfer the style of one
image, say <a href="https://www.artic.edu/artworks/80062/edtaonisl-ecclesiastic">a cubist painting</a>, onto the content of
another, say a photo of your toddler, to arrive at gorgeous results
like these:</p>

<figure>
<div class="pure-g">
  <div class="pure-u-1-3">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/edtaonisl.jpg" alt="The style image, Edtaonisl by Francis Picabia">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/hugo-sleeping.jpg" alt="The content image, my toddler sleeping">
  </div>
  <div class="pure-u-2-3">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/style-transferred.jpg" alt="The style-transferred image generated by Prisma">
  </div>
</div>
<figcaption>A three part image, showing the style image, <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-1-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;s&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1" style="width: 0.578em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.471em; height: 0px; font-size: 118%;"><span style="position: absolute; clip: rect(1.587em, 1000.43em, 2.36em, -1000em); top: -2.197em; left: 0em;"><span class="mrow" id="MathJax-Span-2"><span class="texatom" id="MathJax-Span-3"><span class="mrow" id="MathJax-Span-4"><span class="mi" id="MathJax-Span-5" style="font-family: MathJax_Main; font-weight: bold;">s</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.197em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.069em; border-left: 0px solid; width: 0px; height: 0.665em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">s</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-1">\mathbf{s}</script>, the content image, <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-2-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;c&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-6" style="width: 0.63em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 118%;"><span style="position: absolute; clip: rect(1.587em, 1000.49em, 2.36em, -1000em); top: -2.197em; left: 0em;"><span class="mrow" id="MathJax-Span-7"><span class="texatom" id="MathJax-Span-8"><span class="mrow" id="MathJax-Span-9"><span class="mi" id="MathJax-Span-10" style="font-family: MathJax_Main; font-weight: bold;">c</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.197em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.069em; border-left: 0px solid; width: 0px; height: 0.665em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">c</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-2">\mathbf{c}</script>, and the style-transferred image, <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-3-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-11" style="width: 0.735em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 118%;"><span style="position: absolute; clip: rect(1.596em, 1000.61em, 2.354em, -1000em); top: -2.197em; left: 0em;"><span class="mrow" id="MathJax-Span-12"><span class="texatom" id="MathJax-Span-13"><span class="mrow" id="MathJax-Span-14"><span class="mi" id="MathJax-Span-15" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.197em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.062em; border-left: 0px solid; width: 0px; height: 0.647em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-3">\mathbf{x}</script>, generated by Prisma.</figcaption>
</figure>

<p>Like many people, I found much of the output of this app very
pleasing, and I got curious as to how it achieves its visual
effect. At the outset you can imagine that it’s somehow extracting low
level features like the colour and texture from one image (that we’ll
call the <em>style image</em>, <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-4-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;s&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-16" style="width: 0.529em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.431em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.606em, 1000.39em, 2.353em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-17"><span class="texatom" id="MathJax-Span-18"><span class="mrow" id="MathJax-Span-19"><span class="mi" id="MathJax-Span-20" style="font-family: MathJax_Main; font-weight: bold;">s</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.063em; border-left: 0px solid; width: 0px; height: 0.644em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">s</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-4">\mathbf{s}</script>) and applying it to more
semantic, higher level features like a toddler’s face on another image
(that we’ll call the <em>content image</em>, <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-5-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;c&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-21" style="width: 0.625em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.527em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.606em, 1000.49em, 2.353em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-22"><span class="texatom" id="MathJax-Span-23"><span class="mrow" id="MathJax-Span-24"><span class="mi" id="MathJax-Span-25" style="font-family: MathJax_Main; font-weight: bold;">c</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.063em; border-left: 0px solid; width: 0px; height: 0.644em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">c</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-5">\mathbf{c}</script>) to arrive at the
<em>style-transferred image</em>, <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-6-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-26" style="width: 0.721em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.623em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.615em, 1000.6em, 2.347em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-27"><span class="texatom" id="MathJax-Span-28"><span class="mrow" id="MathJax-Span-29"><span class="mi" id="MathJax-Span-30" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.626em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-6">\mathbf{x}</script>.</p>

<p>Now, how would we even begin to achieve something like this? We could
perhaps do some pixel-level image analysis on the style image to get
things like spatially-averaged colours or even aspects of its
texture. But this brings up a deeper question: How do we go about
explaining to our system that the texture and colour we’re interested
in is at the <em>scale of the brush strokes</em>, not so much the <em>overall
shapes</em> in the painting.</p>

<p>But let’s say we managed to do this anyway. How do we then
<em>selectively apply</em> this style over the content? We can’t just copy
and paste it without losing essential aspects of the content’s
structure. Along the same lines, how do we cleanly <em>discard</em> the
existing style of the content image?</p>

<p>I was stumped by many of these questions really early on, and as one
does, turned to Google for help. My searches soon pointed me to a
really popular paper (<a href="https://arxiv.org/abs/1508.06576">Gatys et al.,
2015</a>) that explains <em>exactly</em> how all
this is achieved. In particular, the paper poses what we’re trying to
do in mathematical terms as an <em>optimisation problem</em>.</p>

<p>Let’s suppose that we had a way of measuring <em>how different in
content</em> two images are from one another. Which means we have a
function that tends to 0 when its two input images (<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-7-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;c&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-31" style="width: 0.625em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.527em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.606em, 1000.49em, 2.353em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-32"><span class="texatom" id="MathJax-Span-33"><span class="mrow" id="MathJax-Span-34"><span class="mi" id="MathJax-Span-35" style="font-family: MathJax_Main; font-weight: bold;">c</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.063em; border-left: 0px solid; width: 0px; height: 0.644em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">c</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-7">\mathbf{c}</script> and
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-8-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-36" style="width: 0.721em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.623em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.615em, 1000.6em, 2.347em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-37"><span class="texatom" id="MathJax-Span-38"><span class="mrow" id="MathJax-Span-39"><span class="mi" id="MathJax-Span-40" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.626em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-8">\mathbf{x}</script>) are very close to each other in terms of content, and
grows as their content deviates. We call this function the <em>content
loss</em>.</p>

<figure>
  <img class="pure-img-half-width" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/content-loss.png" alt="A schematic of the content loss.">
  <figcaption>A schematic of the content loss.</figcaption>
</figure>


<p>Let’s also suppose that had another function that told us <em>how close
in style</em> two images are to one another. Again, this function grows as
its two input images (<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-9-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;s&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-41" style="width: 0.529em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.431em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.606em, 1000.39em, 2.353em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-42"><span class="texatom" id="MathJax-Span-43"><span class="mrow" id="MathJax-Span-44"><span class="mi" id="MathJax-Span-45" style="font-family: MathJax_Main; font-weight: bold;">s</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.063em; border-left: 0px solid; width: 0px; height: 0.644em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">s</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-9">\mathbf{s}</script> and <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-10-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-46" style="width: 0.721em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.623em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.615em, 1000.6em, 2.347em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-47"><span class="texatom" id="MathJax-Span-48"><span class="mrow" id="MathJax-Span-49"><span class="mi" id="MathJax-Span-50" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.626em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-10">\mathbf{x}</script>) tend to deviate
in style.  We call this function the <em>style loss</em>.</p>

<figure>
  <img class="pure-img-half-width" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/style-loss.png" alt="A schematic of the style loss.">
  <figcaption>A schematic of the style loss.</figcaption>
</figure>


<p>Suppose we had these two functions, then the style transfer problem is
easy to state, right? All we need to do is to find an image
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-11-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-51" style="width: 0.721em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.623em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.615em, 1000.6em, 2.347em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-52"><span class="texatom" id="MathJax-Span-53"><span class="mrow" id="MathJax-Span-54"><span class="mi" id="MathJax-Span-55" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.626em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-11">\mathbf{x}</script> that differs as little as possible <em>in terms of content</em>
from the content image <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-12-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;c&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-56" style="width: 0.625em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.527em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.606em, 1000.49em, 2.353em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-57"><span class="texatom" id="MathJax-Span-58"><span class="mrow" id="MathJax-Span-59"><span class="mi" id="MathJax-Span-60" style="font-family: MathJax_Main; font-weight: bold;">c</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.063em; border-left: 0px solid; width: 0px; height: 0.644em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">c</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-12">\mathbf{c}</script>, while simultaneously differing as
little as possible <em>in terms of style</em> from the style image
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-13-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;s&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-61" style="width: 0.529em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.431em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.606em, 1000.39em, 2.353em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-62"><span class="texatom" id="MathJax-Span-63"><span class="mrow" id="MathJax-Span-64"><span class="mi" id="MathJax-Span-65" style="font-family: MathJax_Main; font-weight: bold;">s</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.063em; border-left: 0px solid; width: 0px; height: 0.644em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">s</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-13">\mathbf{s}</script>. In other words, we’d like to simultaneously minimise
both the style and content losses.</p>

<p>This is what is stated in slightly scary math notation below:</p>

<p><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-14-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;msup&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;&amp;#x2217;&lt;/mo&gt;&lt;/msup&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;munder&gt;&lt;mi&gt;argmin&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;/munder&gt;&lt;mrow&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mrow&gt;&lt;mi&gt;&amp;#x03B1;&lt;/mi&gt;&lt;msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;&gt;L&lt;/mi&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;c&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;o&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;n&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;t&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;e&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;n&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;t&lt;/mi&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;c&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;&amp;#x03B2;&lt;/mi&gt;&lt;msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;&gt;L&lt;/mi&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;s&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;t&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;y&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;l&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;e&lt;/mi&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;s&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-66" style="width: 21.746em; display: inline-block;"><span style="display: inline-block; position: relative; width: 18.726em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.453em, 1018.63em, 3.396em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-67"><span class="msubsup" id="MathJax-Span-68"><span style="display: inline-block; position: relative; width: 1.036em; height: 0px;"><span style="position: absolute; clip: rect(3.435em, 1000.59em, 4.167em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-69"><span class="mrow" id="MathJax-Span-70"><span class="mi" id="MathJax-Span-71" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -4.436em; left: 0.607em;"><span class="mo" id="MathJax-Span-72" style="font-size: 70.7%; font-family: MathJax_Main;">∗</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-73" style="font-family: MathJax_Main; padding-left: 0.278em;">=</span><span class="munder" id="MathJax-Span-74" style="padding-left: 0.278em;"><span style="display: inline-block; position: relative; width: 3.059em; height: 0px;"><span style="position: absolute; clip: rect(3.21em, 1003.05em, 4.373em, -1000em); top: -4.023em; left: 0em;"><span class="mi" id="MathJax-Span-75" style="font-family: MathJax_Main;">argmin</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; clip: rect(3.565em, 1000.41em, 4.267em, -1000em); top: -3.217em; left: 1.315em;"><span class="texatom" id="MathJax-Span-76"><span class="mrow" id="MathJax-Span-77"><span class="mi" id="MathJax-Span-78" style="font-size: 70.7%; font-family: MathJax_Main; font-weight: bold;">x</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mrow" id="MathJax-Span-79" style="padding-left: 0.167em;"><span class="mo" id="MathJax-Span-80" style=""><span style="font-family: MathJax_Main;">(</span></span><span class="mrow" id="MathJax-Span-81"><span class="mi" id="MathJax-Span-82" style="font-family: MathJax_Math; font-style: italic;">α</span><span class="msubsup" id="MathJax-Span-83"><span style="display: inline-block; position: relative; width: 3.083em; height: 0px;"><span style="position: absolute; clip: rect(3.174em, 1000.66em, 4.189em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-84"><span class="mrow" id="MathJax-Span-85"><span class="mi" id="MathJax-Span-86" style="font-family: MathJax_Caligraphic;">L</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.69em;"><span class="texatom" id="MathJax-Span-87"><span class="mrow" id="MathJax-Span-88"><span class="texatom" id="MathJax-Span-89"><span class="mrow" id="MathJax-Span-90"><span class="mi" id="MathJax-Span-91" style="font-size: 70.7%; font-family: MathJax_Main;">c</span><span class="mi" id="MathJax-Span-92" style="font-size: 70.7%; font-family: MathJax_Main;">o</span><span class="mi" id="MathJax-Span-93" style="font-size: 70.7%; font-family: MathJax_Main;">n</span><span class="mi" id="MathJax-Span-94" style="font-size: 70.7%; font-family: MathJax_Main;">t</span><span class="mi" id="MathJax-Span-95" style="font-size: 70.7%; font-family: MathJax_Main;">e</span><span class="mi" id="MathJax-Span-96" style="font-size: 70.7%; font-family: MathJax_Main;">n</span><span class="mi" id="MathJax-Span-97" style="font-size: 70.7%; font-family: MathJax_Main;">t</span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-98" style="font-family: MathJax_Main;">(</span><span class="texatom" id="MathJax-Span-99"><span class="mrow" id="MathJax-Span-100"><span class="mi" id="MathJax-Span-101" style="font-family: MathJax_Main; font-weight: bold;">c</span></span></span><span class="mo" id="MathJax-Span-102" style="font-family: MathJax_Main;">,</span><span class="texatom" id="MathJax-Span-103" style="padding-left: 0.167em;"><span class="mrow" id="MathJax-Span-104"><span class="mi" id="MathJax-Span-105" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span><span class="mo" id="MathJax-Span-106" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-107" style="font-family: MathJax_Main; padding-left: 0.222em;">+</span><span class="mi" id="MathJax-Span-108" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">β<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.007em;"></span></span><span class="msubsup" id="MathJax-Span-109"><span style="display: inline-block; position: relative; width: 2.203em; height: 0px;"><span style="position: absolute; clip: rect(3.174em, 1000.66em, 4.189em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-110"><span class="mrow" id="MathJax-Span-111"><span class="mi" id="MathJax-Span-112" style="font-family: MathJax_Caligraphic;">L</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.69em;"><span class="texatom" id="MathJax-Span-113"><span class="mrow" id="MathJax-Span-114"><span class="texatom" id="MathJax-Span-115"><span class="mrow" id="MathJax-Span-116"><span class="mi" id="MathJax-Span-117" style="font-size: 70.7%; font-family: MathJax_Main;">s</span><span class="mi" id="MathJax-Span-118" style="font-size: 70.7%; font-family: MathJax_Main;">t</span><span class="mi" id="MathJax-Span-119" style="font-size: 70.7%; font-family: MathJax_Main;">y</span><span class="mi" id="MathJax-Span-120" style="font-size: 70.7%; font-family: MathJax_Main;">l</span><span class="mi" id="MathJax-Span-121" style="font-size: 70.7%; font-family: MathJax_Main;">e</span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-122" style="font-family: MathJax_Main;">(</span><span class="texatom" id="MathJax-Span-123"><span class="mrow" id="MathJax-Span-124"><span class="mi" id="MathJax-Span-125" style="font-family: MathJax_Main; font-weight: bold;">s</span></span></span><span class="mo" id="MathJax-Span-126" style="font-family: MathJax_Main;">,</span><span class="texatom" id="MathJax-Span-127" style="padding-left: 0.167em;"><span class="mrow" id="MathJax-Span-128"><span class="mi" id="MathJax-Span-129" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span><span class="mo" id="MathJax-Span-130" style="font-family: MathJax_Main;">)</span></span><span class="mo" id="MathJax-Span-131" style=""><span style="font-family: MathJax_Main;">)</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.107em; border-left: 0px solid; width: 0px; height: 2.032em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msup><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow><mo>∗</mo></msup><mo>=</mo><munder><mi>argmin</mi><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow></munder><mrow><mo>(</mo><mrow><mi>α</mi><msub><mrow class="MJX-TeXAtom-ORD"><mi class="MJX-tex-caligraphic" mathvariant="script">L</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi></mrow></mrow></msub><mo stretchy="false">(</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">c</mi></mrow><mo>,</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow><mo stretchy="false">)</mo><mo>+</mo><mi>β</mi><msub><mrow class="MJX-TeXAtom-ORD"><mi class="MJX-tex-caligraphic" mathvariant="script">L</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="normal">s</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">e</mi></mrow></mrow></msub><mo stretchy="false">(</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">s</mi></mrow><mo>,</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow><mo stretchy="false">)</mo></mrow><mo>)</mo></mrow></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-14">
\mathbf{x}^* = \underset{\mathbf{x}}{\operatorname{argmin}}\left(\alpha
\mathcal{L}_{\mathrm{content}}(\mathbf{c}, \mathbf{x}) + \beta
\mathcal{L}_{\mathrm{style}}(\mathbf{s}, \mathbf{x})\right)
</script></p>

<p>Here, <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-15-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;&amp;#x03B1;&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-132" style="width: 0.721em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.623em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.761em, 1000.59em, 2.501em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-133"><span class="mi" id="MathJax-Span-134" style="font-family: MathJax_Math; font-style: italic;">α</span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.068em; border-left: 0px solid; width: 0px; height: 0.637em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>α</mi></math></span></span><script type="math/tex" id="MathJax-Element-15">\alpha</script> and <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-16-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;&amp;#x03B2;&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-135" style="width: 0.673em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.575em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.498em, 1000.58em, 2.684em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-136"><span class="mi" id="MathJax-Span-137" style="font-family: MathJax_Math; font-style: italic;">β<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.007em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.281em; border-left: 0px solid; width: 0px; height: 1.154em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>β</mi></math></span></span><script type="math/tex" id="MathJax-Element-16">\beta</script> are simply numbers that allow us to control
how much we want to emphasise the content relative to the style. We’ll
see some effects of playing with these weighting factors later.</p>

<p>Now the crucial bit of insight in <a href="https://arxiv.org/abs/1508.06576">this paper by Gatys et
al.</a> is that the definitions of these
content and style losses are based not on <em>per-pixel differences</em>
between images, but instead in terms of higher level, more <em>perceptual
differences</em> between them. Interesting, but then how does one go about
writing a program that understands enough about the <em>meaning</em> of
images to perceive such semantic differences?</p>

<p>Well, it turns out we don’t. At least not in the classic sense of a
program with a fixed set of rules. We instead turn to <em>machine
learning</em>, which is a great tool to solve general problems like these
that seem intuitive to state, but where it’s hard to explicitly write
down all the steps you need to follow to solve it. And over the course
of this article, we’re going to learn just how to do this.</p>

<p>We start from a relatively classic place: <a href="#the-image-classification-problem">the image classification
problem</a>. We’re going to slowly
step through solutions of this problem until we’re familiar with a
branch of machine learning that’s great for dealing with images called
<a href="#and-finally-convolutional-neural-networks"><em>Convolutional Neural Networks</em></a> (or
<em>convnets</em>). We’re then going to see how <a href="#returning-to-the-style-transfer-problem">convnets can be used to
define these perceptual loss
functions</a> central to our
style-transfer optimisation problem. We conclude with a <a href="#notebook-6-concrete-implementation-of-the-artistic-style-transfer-algorithm">concrete
implementation of the solution of the
problem</a> (in Keras and
TensorFlow) that you can play with and extend.</p>

<p>It is my hope that by starting our journey at a fairly basic place and
gradually stepping up in complexity as we go along, that you get to
learn something interesting no matter what your level of expertise.</p>

<h2 id="convolutional-neural-networks-from-the-ground-up">Convolutional Neural Networks from the ground up</h2>

<p>This section offers a brief summary of parts of the Stanford course
<a href="http://cs231n.stanford.edu/">Convolutional Neural Networks for Visual Recognition
(CS231n)</a> that are relevant to our style transfer
problem. If you’re even vaguely interested in what you’re reading
here, you should go take this course. <em>It is outstanding</em>.</p>

<h3 id="the-image-classification-problem">The image classification problem</h3>

<p>We begin our journey with a look at the <em>image classification</em>
problem. This is a deceptively simple problem to state: Given an input
image, have a computer automatically classify it into one of a fixed
set of categories, say “baby”, “dog”, “car” or “toothbrush”. And the
reason we’re starting with this problem is that it’s at the core of
many seemingly unrelated tasks in computer vision, including our quest
to reproduce Prisma’s visual effect.</p>

<p>In more precise terms, imagine a three channel colour image (RGB)
that’s <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-17-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;W&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-138" style="width: 1.248em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.054em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.52em, 1001.05em, 2.512em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-139"><span class="mi" id="MathJax-Span-140" style="font-family: MathJax_Math; font-style: italic;">W<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.104em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.081em; border-left: 0px solid; width: 0px; height: 0.929em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>W</mi></math></span></span><script type="math/tex" id="MathJax-Element-17">W</script> pixels wide and <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-18-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;H&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-141" style="width: 1.056em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.91em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.52em, 1000.91em, 2.49em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-142"><span class="mi" id="MathJax-Span-143" style="font-family: MathJax_Math; font-style: italic;">H<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.057em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.903em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>H</mi></math></span></span><script type="math/tex" id="MathJax-Element-18">H</script> pixels tall. This image can be
represented in a computer as an array of <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-19-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;D&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mi&gt;W&lt;/mi&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mi&gt;H&lt;/mi&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-144" style="width: 8.192em; display: inline-block;"><span style="display: inline-block; position: relative; width: 7.04em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.52em, 1007em, 2.512em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-145"><span class="mi" id="MathJax-Span-146" style="font-family: MathJax_Math; font-style: italic;">D</span><span class="mo" id="MathJax-Span-147" style="font-family: MathJax_Main; padding-left: 0.278em;">=</span><span class="mi" id="MathJax-Span-148" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.278em;">W<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.104em;"></span></span><span class="mo" id="MathJax-Span-149" style="font-family: MathJax_Main; padding-left: 0.222em;">×</span><span class="mi" id="MathJax-Span-150" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">H<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.057em;"></span></span><span class="mo" id="MathJax-Span-151" style="font-family: MathJax_Main; padding-left: 0.222em;">×</span><span class="mn" id="MathJax-Span-152" style="font-family: MathJax_Main; padding-left: 0.222em;">3</span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.081em; border-left: 0px solid; width: 0px; height: 0.929em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>D</mi><mo>=</mo><mi>W</mi><mo>×</mo><mi>H</mi><mo>×</mo><mn>3</mn></math></span></span><script type="math/tex" id="MathJax-Element-19">D = W \times H \times 3</script>
numbers, each going between <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-20-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-153" style="width: 0.577em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.479em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.441em, 1000.44em, 2.417em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-154"><span class="mn" id="MathJax-Span-155" style="font-family: MathJax_Main;">0</span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.081em; border-left: 0px solid; width: 0px; height: 0.909em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>0</mn></math></span></span><script type="math/tex" id="MathJax-Element-20">0</script> (minimum brightness) and <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-21-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-156" style="width: 0.577em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.479em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.441em, 1000.41em, 2.395em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-157"><span class="mn" id="MathJax-Span-158" style="font-family: MathJax_Main;">1</span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.884em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>1</mn></math></span></span><script type="math/tex" id="MathJax-Element-21">1</script> (maximum
brightness). Let’s further assume that we have <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-22-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-159" style="width: 1.056em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.91em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.52em, 1000.91em, 2.49em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-160"><span class="mi" id="MathJax-Span-161" style="font-family: MathJax_Math; font-style: italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.04em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.903em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>K</mi></math></span></span><script type="math/tex" id="MathJax-Element-22">K</script> categories of
things that we’d like to classify the image as being one of. The task
then is to come up with a function that takes as input one of these
large arrays of numbers, and outputs the correct label from our set of
categories, e.g. “baby”.</p>

<figure>
  <img class="pure-img-three-fourths-width" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/image-classification-problem.png" alt="The image classification problem.">
  <figcaption>The image classification problem.</figcaption>
</figure>


<p>In fact, instead of just reporting one category name, it would be more
helpful to get a <em>confidence score</em> for each category. This way, we’ll
not only get the primary category we’re looking for (the largest
score), but we’ll also have a sense of how confident we are with our
classification. So in essence, what we’re looking for is a <em>score
function</em> <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-23-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;f&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;:&lt;/mo&gt;&lt;msup&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;double-struck&quot;&gt;R&lt;/mi&gt;&lt;/mrow&gt;&lt;mi&gt;D&lt;/mi&gt;&lt;/msup&gt;&lt;mo stretchy=&quot;false&quot;&gt;&amp;#x21A6;&lt;/mo&gt;&lt;msup&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;double-struck&quot;&gt;R&lt;/mi&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-162" style="width: 6.564em; display: inline-block;"><span style="display: inline-block; position: relative; width: 5.651em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.214em, 1005.65em, 2.406em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-163"><span class="texatom" id="MathJax-Span-164"><span class="mrow" id="MathJax-Span-165"><span class="mi" id="MathJax-Span-166" style="font-family: MathJax_Main; font-weight: bold;">f<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.101em;"></span></span></span></span><span class="mo" id="MathJax-Span-167" style="font-family: MathJax_Main; padding-left: 0.278em;">:</span><span class="msubsup" id="MathJax-Span-168" style="padding-left: 0.278em;"><span style="display: inline-block; position: relative; width: 1.382em; height: 0px;"><span style="position: absolute; clip: rect(3.196em, 1000.71em, 4.168em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-169"><span class="mrow" id="MathJax-Span-170"><span class="mi" id="MathJax-Span-171" style="font-family: MathJax_AMS;">R</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -4.433em; left: 0.722em;"><span class="mi" id="MathJax-Span-172" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">D</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-173" style="font-family: MathJax_Main; padding-left: 0.278em;">↦</span><span class="msubsup" id="MathJax-Span-174" style="padding-left: 0.278em;"><span style="display: inline-block; position: relative; width: 1.426em; height: 0px;"><span style="position: absolute; clip: rect(3.196em, 1000.71em, 4.168em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-175"><span class="mrow" id="MathJax-Span-176"><span class="mi" id="MathJax-Span-177" style="font-family: MathJax_AMS;">R</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -4.433em; left: 0.722em;"><span class="texatom" id="MathJax-Span-178"><span class="mrow" id="MathJax-Span-179"><span class="mi" id="MathJax-Span-180" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.028em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.068em; border-left: 0px solid; width: 0px; height: 1.16em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">f</mi></mrow><mo>:</mo><msup><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="double-struck">R</mi></mrow><mi>D</mi></msup><mo stretchy="false">↦</mo><msup><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="double-struck">R</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mi>K</mi></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-23">\mathbf{f}: \mathbb{R}^D \mapsto \mathbb{R}^{K}</script> that maps
image data to class scores.</p>

<p>How might we write such a function? One naïve approach would be to
hardcode some characteristics of babies (such as large heads, snotty
noses, rounded cheeks, …) into our function. But even if you knew
how to do this, what if you then wanted to look for cars?  What about
different kinds of cars? What about toothbrushes? What if our set of
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-24-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-181" style="width: 1.056em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.91em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.52em, 1000.91em, 2.49em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-182"><span class="mi" id="MathJax-Span-183" style="font-family: MathJax_Math; font-style: italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.04em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.903em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>K</mi></math></span></span><script type="math/tex" id="MathJax-Element-24">K</script> categories became arbitrarily large and nuanced?</p>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/image-classification-challenges.jpg" alt="Some of the challenges in getting a computer to classify images. (Reproduced from CS231n notes.)">
  <figcaption>Some of the challenges in getting a computer to classify images. (Reproduced from CS231n notes.)</figcaption>
</figure>


<p>To further complicate the problem, note that any slight change in the
situation under which the image was captured (illumination, viewpoint,
background clutter, …) greatly affects the array of numbers being
passed as input to our function. How do we write our classification
function to ignore these sorts of superfluous differences while still
giving it the ability to distinguish between a “baby” and a “toddler”?</p>

<p>These questions have the same flavour of difficulty as defining
<em>perceptual differences</em> for the style transfer problem we saw
earlier. And the reason for this is that there is a <em>semantic gap</em>
between the input representation for images (an array of numbers) and
what we’re looking for (a category classification). So we give up on
trying to write this classification function ourselves, and instead
turn to <em>machine learning</em> to <em>automatically discover the appropriate
representations</em> needed to solve this problem for us.</p>

<p>This concept is the intellectual core of this article.</p>

<h3 id="a-supervised-learning-approach-to-the-image-classification-problem">A supervised learning approach to the image classification problem</h3>

<p>The branch of machine learning we turn to solve the image
classification problem is called <em>supervised learning</em>. In fact, when
you hear most people talking about machine learning today (deep
learning or otherwise), what they’re probably referring to is
supervised learning, as it is the subset of machine learning that has
demonstrated the most success in recent years. Supervised learning is
now the classic procedure for <em>learning from data</em>, and it is outlined
below in the context of the image classification problem:</p>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/supervised-learning.png" alt="The pieces that make up a supervised learning solution to the image classification problem.">
  <figcaption>The pieces that make up a supervised learning solution to the image classification problem.</figcaption>
</figure>


<ol>
<li><p>We start with a set of pre-classified example images, which means
we have a set of images with known labels. This is called the
<em>training data</em>, and these serve as the ground truth that our system
is going learn from.</p></li>

<li><p>The function we’re trying to find is called the <em>score function</em>,
which maps a given image to category scores. To define what we’re
looking for, we first make a guess for its functional form and have it
depend on a bunch of <em>parameters</em> <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-25-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;&amp;#x03B8;&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-184" style="width: 0.577em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.479em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.498em, 1000.47em, 2.5em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-185"><span class="texatom" id="MathJax-Span-186"><span class="mrow" id="MathJax-Span-187"><span class="mi" id="MathJax-Span-188" style="font-family: MathJax_Math; font-style: italic;">θ</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.067em; border-left: 0px solid; width: 0px; height: 0.941em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi>θ</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-25">\mathbf{\theta}</script> that we need to
find.</p></li>

<li><p>We introduce a <em>loss</em> function, <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-26-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;&gt;L&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-189" style="width: 0.817em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.67em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.354em, 1000.64em, 2.369em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-190"><span class="texatom" id="MathJax-Span-191"><span class="mrow" id="MathJax-Span-192"><span class="mi" id="MathJax-Span-193" style="font-family: MathJax_Caligraphic;">L</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.081em; border-left: 0px solid; width: 0px; height: 0.954em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi class="MJX-tex-caligraphic" mathvariant="script">L</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-26">\mathcal{L}</script>, which quantifies
the disagreement between what our score function suggests for the
category scores and what our training data provides as the known
truth. Thus, this loss function goes up if the score function is doing
a poor job and goes down if it’s doing great.</p></li>

<li><p>And finally, we have a <em>learning</em> or <em>optimisation algorithm</em>. This
is a mechanism to feed our system a bunch of training data, and have
it iteratively improve the score function by tweaking its parameters
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-27-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;&amp;#x03B8;&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-194" style="width: 0.577em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.479em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.498em, 1000.47em, 2.5em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-195"><span class="texatom" id="MathJax-Span-196"><span class="mrow" id="MathJax-Span-197"><span class="mi" id="MathJax-Span-198" style="font-family: MathJax_Math; font-style: italic;">θ</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.067em; border-left: 0px solid; width: 0px; height: 0.941em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi>θ</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-27">\mathbf{\theta}</script>. The goal of the learning process is determine
parameters that give us the best (i.e. lowest) loss.</p></li>
</ol>

<p>Once we’ve completed this process and learnt a suitable score
function, we hope that it <em>generalises</em> well. That is, the function
works well for general input (called <em>test data</em>) that it hasn’t seen
before.</p>

<p>Much of the excitement around machine learning today stems from making
specific choices for these different pieces, allowing us to learn
powerful functions that map a diverse set of inputs and outputs. And
in what follows, we’re going to make increasingly sophisticated
choices for these pieces aimed at incrementally better solutions to
the image classification problem.</p>

<h3 id="the-linear-image-classifier">The linear image classifier</h3>

<p>Recall the classification problem we’re trying to solve. We have an
image <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-28-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-199" style="width: 0.721em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.623em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.615em, 1000.6em, 2.347em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-200"><span class="texatom" id="MathJax-Span-201"><span class="mrow" id="MathJax-Span-202"><span class="mi" id="MathJax-Span-203" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.626em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-28">\mathbf{x}</script> that’s represented as an array of numbers of length
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-29-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;D&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-204" style="width: 0.96em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.814em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.52em, 1000.79em, 2.49em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-205"><span class="mi" id="MathJax-Span-206" style="font-family: MathJax_Math; font-style: italic;">D</span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.903em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>D</mi></math></span></span><script type="math/tex" id="MathJax-Element-29">D</script> (<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-30-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mi&gt;W&lt;/mi&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mi&gt;H&lt;/mi&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-207" style="width: 6.899em; display: inline-block;"><span style="display: inline-block; position: relative; width: 5.939em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.509em, 1005.94em, 2.512em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-208"><span class="mo" id="MathJax-Span-209" style="font-family: MathJax_Main;">=</span><span class="mi" id="MathJax-Span-210" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.278em;">W<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.104em;"></span></span><span class="mo" id="MathJax-Span-211" style="font-family: MathJax_Main; padding-left: 0.222em;">×</span><span class="mi" id="MathJax-Span-212" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">H<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.057em;"></span></span><span class="mo" id="MathJax-Span-213" style="font-family: MathJax_Main; padding-left: 0.222em;">×</span><span class="mi" id="MathJax-Span-214" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">d<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.081em; border-left: 0px solid; width: 0px; height: 0.942em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo>=</mo><mi>W</mi><mo>×</mo><mi>H</mi><mo>×</mo><mi>d</mi></math></span></span><script type="math/tex" id="MathJax-Element-30">= W \times H \times d</script>, where <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-31-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-215" style="width: 0.625em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.527em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.509em, 1000.53em, 2.5em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-216"><span class="mi" id="MathJax-Span-217" style="font-family: MathJax_Math; font-style: italic;">d<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.067em; border-left: 0px solid; width: 0px; height: 0.928em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>d</mi></math></span></span><script type="math/tex" id="MathJax-Element-31">d</script>, the <em>colour depth</em>, is <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-32-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-218" style="width: 0.577em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.479em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.441em, 1000.41em, 2.395em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-219"><span class="mn" id="MathJax-Span-220" style="font-family: MathJax_Main;">1</span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.884em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>1</mn></math></span></span><script type="math/tex" id="MathJax-Element-32">1</script>
for a greyscale image and <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-33-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-221" style="width: 0.577em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.479em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.442em, 1000.44em, 2.417em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-222"><span class="mn" id="MathJax-Span-223" style="font-family: MathJax_Main;">3</span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.081em; border-left: 0px solid; width: 0px; height: 0.908em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>3</mn></math></span></span><script type="math/tex" id="MathJax-Element-33">3</script> for an RGB colour image). We want to
find out which category (in a set of <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-34-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-224" style="width: 1.056em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.91em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.52em, 1000.91em, 2.49em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-225"><span class="mi" id="MathJax-Span-226" style="font-family: MathJax_Math; font-style: italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.04em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.903em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>K</mi></math></span></span><script type="math/tex" id="MathJax-Element-34">K</script> categories) that it belongs
to. So what we’re really looking for is a <em>score function</em>
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-35-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;f&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;:&lt;/mo&gt;&lt;msup&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;double-struck&quot;&gt;R&lt;/mi&gt;&lt;/mrow&gt;&lt;mi&gt;D&lt;/mi&gt;&lt;/msup&gt;&lt;mo stretchy=&quot;false&quot;&gt;&amp;#x21A6;&lt;/mo&gt;&lt;msup&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;double-struck&quot;&gt;R&lt;/mi&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-227" style="width: 6.564em; display: inline-block;"><span style="display: inline-block; position: relative; width: 5.651em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.214em, 1005.65em, 2.406em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-228"><span class="texatom" id="MathJax-Span-229"><span class="mrow" id="MathJax-Span-230"><span class="mi" id="MathJax-Span-231" style="font-family: MathJax_Main; font-weight: bold;">f<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.101em;"></span></span></span></span><span class="mo" id="MathJax-Span-232" style="font-family: MathJax_Main; padding-left: 0.278em;">:</span><span class="msubsup" id="MathJax-Span-233" style="padding-left: 0.278em;"><span style="display: inline-block; position: relative; width: 1.382em; height: 0px;"><span style="position: absolute; clip: rect(3.196em, 1000.71em, 4.168em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-234"><span class="mrow" id="MathJax-Span-235"><span class="mi" id="MathJax-Span-236" style="font-family: MathJax_AMS;">R</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -4.433em; left: 0.722em;"><span class="mi" id="MathJax-Span-237" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">D</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-238" style="font-family: MathJax_Main; padding-left: 0.278em;">↦</span><span class="msubsup" id="MathJax-Span-239" style="padding-left: 0.278em;"><span style="display: inline-block; position: relative; width: 1.426em; height: 0px;"><span style="position: absolute; clip: rect(3.196em, 1000.71em, 4.168em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-240"><span class="mrow" id="MathJax-Span-241"><span class="mi" id="MathJax-Span-242" style="font-family: MathJax_AMS;">R</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -4.433em; left: 0.722em;"><span class="texatom" id="MathJax-Span-243"><span class="mrow" id="MathJax-Span-244"><span class="mi" id="MathJax-Span-245" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.028em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.068em; border-left: 0px solid; width: 0px; height: 1.16em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">f</mi></mrow><mo>:</mo><msup><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="double-struck">R</mi></mrow><mi>D</mi></msup><mo stretchy="false">↦</mo><msup><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="double-struck">R</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mi>K</mi></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-35">\mathbf{f}: \mathbb{R}^D \mapsto \mathbb{R}^{K}</script> that maps image data
to class scores.</p>

<p>The simplest possible example of such a function is a linear
map:</p>

<p><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-36-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;f&lt;/mi&gt;&lt;/mrow&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;;&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;W&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;b&lt;/mi&gt;&lt;/mrow&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;W&lt;/mi&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;b&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-246" style="width: 11.401em; display: inline-block;"><span style="display: inline-block; position: relative; width: 9.818em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.357em, 1009.75em, 2.645em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-247"><span class="texatom" id="MathJax-Span-248"><span class="mrow" id="MathJax-Span-249"><span class="mi" id="MathJax-Span-250" style="font-family: MathJax_Main; font-weight: bold;">f<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.101em;"></span></span></span></span><span class="mo" id="MathJax-Span-251" style="font-family: MathJax_Main;">(</span><span class="texatom" id="MathJax-Span-252"><span class="mrow" id="MathJax-Span-253"><span class="mi" id="MathJax-Span-254" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span><span class="mo" id="MathJax-Span-255" style="font-family: MathJax_Main;">;</span><span class="texatom" id="MathJax-Span-256" style="padding-left: 0.167em;"><span class="mrow" id="MathJax-Span-257"><span class="mi" id="MathJax-Span-258" style="font-family: MathJax_Main; font-weight: bold;">W</span></span></span><span class="mo" id="MathJax-Span-259" style="font-family: MathJax_Main;">,</span><span class="texatom" id="MathJax-Span-260" style="padding-left: 0.167em;"><span class="mrow" id="MathJax-Span-261"><span class="mi" id="MathJax-Span-262" style="font-family: MathJax_Main; font-weight: bold;">b</span></span></span><span class="mo" id="MathJax-Span-263" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-264" style="font-family: MathJax_Main; padding-left: 0.278em;">=</span><span class="texatom" id="MathJax-Span-265" style="padding-left: 0.278em;"><span class="mrow" id="MathJax-Span-266"><span class="mi" id="MathJax-Span-267" style="font-family: MathJax_Main; font-weight: bold;">W</span></span></span><span class="texatom" id="MathJax-Span-268"><span class="mrow" id="MathJax-Span-269"><span class="mi" id="MathJax-Span-270" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span><span class="mo" id="MathJax-Span-271" style="font-family: MathJax_Main; padding-left: 0.222em;">+</span><span class="texatom" id="MathJax-Span-272" style="padding-left: 0.222em;"><span class="mrow" id="MathJax-Span-273"><span class="mi" id="MathJax-Span-274" style="font-family: MathJax_Main; font-weight: bold;">b</span></span></span><span class="mo" id="MathJax-Span-275" style="font-family: MathJax_Main;">,</span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.346em; border-left: 0px solid; width: 0px; height: 1.271em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">f</mi></mrow><mo stretchy="false">(</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow><mo>;</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">W</mi></mrow><mo>,</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">b</mi></mrow><mo stretchy="false">)</mo><mo>=</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">W</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow><mo>+</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">b</mi></mrow><mo>,</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-36">
\mathbf{f}(\mathbf{x}; \mathbf{W}, \mathbf{b}) = \mathbf{W}\mathbf{x}
+ \mathbf{b},
</script></p>

<p>which introduces two parameters we need to learn: a matrix
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-37-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;W&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-276" style="width: 1.391em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.197em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.373em, 1001.17em, 2.354em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-277"><span class="texatom" id="MathJax-Span-278"><span class="mrow" id="MathJax-Span-279"><span class="mi" id="MathJax-Span-280" style="font-family: MathJax_Main; font-weight: bold;">W</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.064em; border-left: 0px solid; width: 0px; height: 0.915em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">W</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-37">\mathbf{W}</script> (of size <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-38-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mi&gt;D&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-281" style="width: 3.403em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.921em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.52em, 1002.9em, 2.49em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-282"><span class="mi" id="MathJax-Span-283" style="font-family: MathJax_Math; font-style: italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.04em;"></span></span><span class="mo" id="MathJax-Span-284" style="font-family: MathJax_Main; padding-left: 0.222em;">×</span><span class="mi" id="MathJax-Span-285" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">D</span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.903em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>K</mi><mo>×</mo><mi>D</mi></math></span></span><script type="math/tex" id="MathJax-Element-38">K \times D</script>, called the <em>weights</em>) and a vector
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-39-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;b&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-286" style="width: 0.721em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.623em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.365em, 1000.58em, 2.353em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-287"><span class="texatom" id="MathJax-Span-288"><span class="mrow" id="MathJax-Span-289"><span class="mi" id="MathJax-Span-290" style="font-family: MathJax_Main; font-weight: bold;">b</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.063em; border-left: 0px solid; width: 0px; height: 0.923em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">b</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-39">\mathbf{b}</script> (of size <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-40-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-291" style="width: 3.068em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.634em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.52em, 1002.56em, 2.49em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-292"><span class="mi" id="MathJax-Span-293" style="font-family: MathJax_Math; font-style: italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.04em;"></span></span><span class="mo" id="MathJax-Span-294" style="font-family: MathJax_Main; padding-left: 0.222em;">×</span><span class="mn" id="MathJax-Span-295" style="font-family: MathJax_Main; padding-left: 0.222em;">1</span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.903em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>K</mi><mo>×</mo><mn>1</mn></math></span></span><script type="math/tex" id="MathJax-Element-40">K \times 1</script>, called the <em>biases</em>).</p>

<p>Since we want to interpret the output vector of this linear map as the
probability for each category, we pass this output through something
called a <em><a href="https://en.wikipedia.org/wiki/Softmax_function">softmax</a> function</em> <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-41-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;&amp;#x03C3;&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-296" style="width: 0.673em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.575em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.772em, 1000.58em, 2.501em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-297"><span class="mi" id="MathJax-Span-298" style="font-family: MathJax_Math; font-style: italic;">σ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.001em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.068em; border-left: 0px solid; width: 0px; height: 0.624em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>σ</mi></math></span></span><script type="math/tex" id="MathJax-Element-41">\sigma</script> that squashes the
scores to a set of numbers between 0 and 1 that add up to 1.</p>

<p><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-42-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mi&gt;j&lt;/mi&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mi&gt;&amp;#x03C3;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;f&lt;/mi&gt;&lt;/mrow&gt;&lt;msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mi&gt;j&lt;/mi&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mfrac&gt;&lt;msup&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;msub&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;mi&gt;j&lt;/mi&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;mrow&gt;&lt;munderover&gt;&lt;mo&gt;&amp;#x2211;&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi&gt;k&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/mrow&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;/munderover&gt;&lt;msup&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;msub&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;mi&gt;k&lt;/mi&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-299" style="width: 11.401em; display: inline-block;"><span style="display: inline-block; position: relative; width: 9.818em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(0.648em, 1009.82em, 3.703em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-300"><span class="msubsup" id="MathJax-Span-301"><span style="display: inline-block; position: relative; width: 0.835em; height: 0px;"><span style="position: absolute; clip: rect(3.437em, 1000.42em, 4.177em, -1000em); top: -4.023em; left: 0em;"><span class="mi" id="MathJax-Span-302" style="font-family: MathJax_Math; font-style: italic;">s</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.469em;"><span class="mi" id="MathJax-Span-303" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">j</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-304" style="font-family: MathJax_Main; padding-left: 0.278em;">=</span><span class="mi" id="MathJax-Span-305" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.278em;">σ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.001em;"></span></span><span class="mo" id="MathJax-Span-306" style="font-family: MathJax_Main;">(</span><span class="texatom" id="MathJax-Span-307"><span class="mrow" id="MathJax-Span-308"><span class="mi" id="MathJax-Span-309" style="font-family: MathJax_Main; font-weight: bold;">f<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.101em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-310"><span style="display: inline-block; position: relative; width: 0.755em; height: 0px;"><span style="position: absolute; clip: rect(3.129em, 1000.29em, 4.417em, -1000em); top: -4.023em; left: 0em;"><span class="mo" id="MathJax-Span-311" style="font-family: MathJax_Main;">)</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.389em;"><span class="mi" id="MathJax-Span-312" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">j</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-313" style="font-family: MathJax_Main; padding-left: 0.278em;">=</span><span class="mfrac" id="MathJax-Span-314" style="padding-left: 0.278em;"><span style="display: inline-block; position: relative; width: 3.891em; height: 0px; margin-right: 0.12em; margin-left: 0.12em;"><span style="position: absolute; clip: rect(3.001em, 1001.15em, 4.178em, -1000em); top: -4.699em; left: 50%; margin-left: -0.573em;"><span class="msubsup" id="MathJax-Span-315"><span style="display: inline-block; position: relative; width: 1.147em; height: 0px;"><span style="position: absolute; clip: rect(3.437em, 1000.43em, 4.178em, -1000em); top: -4.023em; left: 0em;"><span class="mi" id="MathJax-Span-316" style="font-family: MathJax_Math; font-style: italic;">e</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -4.403em; left: 0.466em;"><span class="texatom" id="MathJax-Span-317"><span class="mrow" id="MathJax-Span-318"><span class="msubsup" id="MathJax-Span-319"><span style="display: inline-block; position: relative; width: 0.606em; height: 0px;"><span style="position: absolute; clip: rect(3.381em, 1000.39em, 4.312em, -1000em); top: -4.023em; left: 0em;"><span class="mi" id="MathJax-Span-320" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">f<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.042em;"></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.853em; left: 0.346em;"><span class="mi" id="MathJax-Span-321" style="font-size: 50%; font-family: MathJax_Math; font-style: italic;">j</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; clip: rect(2.919em, 1003.77em, 4.46em, -1000em); top: -3.103em; left: 50%; margin-left: -1.886em;"><span class="mrow" id="MathJax-Span-322"><span class="munderover" id="MathJax-Span-323"><span style="display: inline-block; position: relative; width: 2.403em; height: 0px;"><span style="position: absolute; clip: rect(3.129em, 1001em, 4.417em, -1000em); top: -4.023em; left: 0em;"><span class="mo" id="MathJax-Span-324" style="font-family: MathJax_Size1; vertical-align: 0em;">∑</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; clip: rect(3.396em, 1000.7em, 4.167em, -1000em); top: -4.5em; left: 1.056em;"><span class="mi" id="MathJax-Span-325" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.028em;"></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; clip: rect(3.389em, 1001.35em, 4.174em, -1000em); top: -3.738em; left: 1.056em;"><span class="texatom" id="MathJax-Span-326"><span class="mrow" id="MathJax-Span-327"><span class="mi" id="MathJax-Span-328" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">k</span><span class="mo" id="MathJax-Span-329" style="font-size: 70.7%; font-family: MathJax_Main;">=</span><span class="mn" id="MathJax-Span-330" style="font-size: 70.7%; font-family: MathJax_Main;">1</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-331" style="padding-left: 0.167em;"><span style="display: inline-block; position: relative; width: 1.201em; height: 0px;"><span style="position: absolute; clip: rect(3.437em, 1000.43em, 4.178em, -1000em); top: -4.023em; left: 0em;"><span class="mi" id="MathJax-Span-332" style="font-family: MathJax_Math; font-style: italic;">e</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -4.312em; left: 0.466em;"><span class="texatom" id="MathJax-Span-333"><span class="mrow" id="MathJax-Span-334"><span class="msubsup" id="MathJax-Span-335"><span style="display: inline-block; position: relative; width: 0.66em; height: 0px;"><span style="position: absolute; clip: rect(3.381em, 1000.39em, 4.312em, -1000em); top: -4.023em; left: 0em;"><span class="mi" id="MathJax-Span-336" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">f<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.042em;"></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.853em; left: 0.346em;"><span class="mi" id="MathJax-Span-337" style="font-size: 50%; font-family: MathJax_Math; font-style: italic;">k</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; clip: rect(0.85em, 1003.89em, 1.197em, -1000em); top: -1.274em; left: 0em;"><span style="display: inline-block; overflow: hidden; vertical-align: 0em; border-top: 1.3px solid; width: 3.891em; height: 0px;"></span><span style="display: inline-block; width: 0px; height: 1.054em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.462em; border-left: 0px solid; width: 0px; height: 3.321em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi>s</mi><mi>j</mi></msub><mo>=</mo><mi>σ</mi><mo stretchy="false">(</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">f</mi></mrow><msub><mo stretchy="false">)</mo><mi>j</mi></msub><mo>=</mo><mfrac><msup><mi>e</mi><mrow class="MJX-TeXAtom-ORD"><msub><mi>f</mi><mi>j</mi></msub></mrow></msup><mrow><munderover><mo>∑</mo><mrow class="MJX-TeXAtom-ORD"><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msup><mi>e</mi><mrow class="MJX-TeXAtom-ORD"><msub><mi>f</mi><mi>k</mi></msub></mrow></msup></mrow></mfrac></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-42">
s_j = \sigma(\mathbf{f})_j = \frac{e^{f_j}}{\sum_{k=1}^K e^{f_k}}
</script></p>

<p>Let’s suppose our training data is a set of <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-43-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;N&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-338" style="width: 1.056em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.91em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.52em, 1000.91em, 2.49em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-339"><span class="mi" id="MathJax-Span-340" style="font-family: MathJax_Math; font-style: italic;">N<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.085em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.903em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>N</mi></math></span></span><script type="math/tex" id="MathJax-Element-43">N</script> pre-classified
examples <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-44-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;msub&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;i&lt;/mi&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;mo&gt;&amp;#x2208;&lt;/mo&gt;&lt;msup&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;double-struck&quot;&gt;R&lt;/mi&gt;&lt;/mrow&gt;&lt;mi&gt;D&lt;/mi&gt;&lt;/msup&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-341" style="width: 4.073em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.496em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.214em, 1003.5em, 2.545em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-342"><span class="texatom" id="MathJax-Span-343"><span class="mrow" id="MathJax-Span-344"><span class="msubsup" id="MathJax-Span-345"><span style="display: inline-block; position: relative; width: 0.908em; height: 0px;"><span style="position: absolute; clip: rect(3.435em, 1000.59em, 4.167em, -1000em); top: -4.023em; left: 0em;"><span class="mi" id="MathJax-Span-346" style="font-family: MathJax_Main; font-weight: bold;">x</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.607em;"><span class="mi" id="MathJax-Span-347" style="font-size: 70.7%; font-family: MathJax_Main; font-weight: bold;">i</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span></span></span><span class="mo" id="MathJax-Span-348" style="font-family: MathJax_Main; padding-left: 0.278em;">∈</span><span class="msubsup" id="MathJax-Span-349" style="padding-left: 0.278em;"><span style="display: inline-block; position: relative; width: 1.382em; height: 0px;"><span style="position: absolute; clip: rect(3.196em, 1000.71em, 4.168em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-350"><span class="mrow" id="MathJax-Span-351"><span class="mi" id="MathJax-Span-352" style="font-family: MathJax_AMS;">R</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -4.433em; left: 0.722em;"><span class="mi" id="MathJax-Span-353" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">D</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.23em; border-left: 0px solid; width: 0px; height: 1.321em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">i</mi></msub></mrow><mo>∈</mo><msup><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="double-struck">R</mi></mrow><mi>D</mi></msup></math></span></span><script type="math/tex" id="MathJax-Element-44">\mathbf{x_i} \in \mathbb{R}^D</script>, each with correct category
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-45-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/msub&gt;&lt;mo&gt;&amp;#x2208;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mo&gt;&amp;#x2026;&lt;/mo&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-354" style="width: 6.564em; display: inline-block;"><span style="display: inline-block; position: relative; width: 5.651em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.52em, 1005.65em, 2.695em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-355"><span class="msubsup" id="MathJax-Span-356"><span style="display: inline-block; position: relative; width: 0.809em; height: 0px;"><span style="position: absolute; clip: rect(3.437em, 1000.5em, 4.372em, -1000em); top: -4.023em; left: 0em;"><span class="mi" id="MathJax-Span-357" style="font-family: MathJax_Math; font-style: italic;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.006em;"></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.49em;"><span class="mi" id="MathJax-Span-358" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">i</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-359" style="font-family: MathJax_Main; padding-left: 0.278em;">∈</span><span class="mn" id="MathJax-Span-360" style="font-family: MathJax_Main; padding-left: 0.278em;">1</span><span class="mo" id="MathJax-Span-361" style="font-family: MathJax_Main;">,</span><span class="mo" id="MathJax-Span-362" style="font-family: MathJax_Main; padding-left: 0.167em;">…</span><span class="mo" id="MathJax-Span-363" style="font-family: MathJax_Main; padding-left: 0.167em;">,</span><span class="mi" id="MathJax-Span-364" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.167em;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.04em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.293em; border-left: 0px solid; width: 0px; height: 1.141em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>y</mi><mi>i</mi></msub><mo>∈</mo><mn>1</mn><mo>,</mo><mo>…</mo><mo>,</mo><mi>K</mi></math></span></span><script type="math/tex" id="MathJax-Element-45">y_i \in 1, \ldots, K</script>. A <a href="https://jamesmccaffrey.wordpress.com/2013/11/05/why-you-should-use-cross-entropy-error-instead-of-classification-error-or-mean-squared-error-for-neural-network-classifier-training/">good functional form</a>
to determine the total loss across all these examples is the <em><a href="https://en.wikipedia.org/wiki/Cross_entropy">cross
entropy</a> loss</em>:</p>

<p><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-46-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;&gt;L&lt;/mi&gt;&lt;/mrow&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;s&lt;/mi&gt;&lt;/mrow&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;munder&gt;&lt;mo&gt;&amp;#x2211;&lt;/mo&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/munder&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;g&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mi&gt;s&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;msub&gt;&lt;mi&gt;y&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-365" style="width: 10.395em; display: inline-block;"><span style="display: inline-block; position: relative; width: 8.956em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.253em, 1008.86em, 3.682em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-366"><span class="texatom" id="MathJax-Span-367"><span class="mrow" id="MathJax-Span-368"><span class="mi" id="MathJax-Span-369" style="font-family: MathJax_Caligraphic;">L</span></span></span><span class="mo" id="MathJax-Span-370" style="font-family: MathJax_Main;">(</span><span class="texatom" id="MathJax-Span-371"><span class="mrow" id="MathJax-Span-372"><span class="mi" id="MathJax-Span-373" style="font-family: MathJax_Main; font-weight: bold;">s</span></span></span><span class="mo" id="MathJax-Span-374" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-375" style="font-family: MathJax_Main; padding-left: 0.278em;">=</span><span class="mo" id="MathJax-Span-376" style="font-family: MathJax_Main; padding-left: 0.278em;">−</span><span class="munderover" id="MathJax-Span-377" style="padding-left: 0.167em;"><span style="display: inline-block; position: relative; width: 1.444em; height: 0px;"><span style="position: absolute; clip: rect(2.929em, 1001.39em, 4.617em, -1000em); top: -4.023em; left: 0em;"><span class="mo" id="MathJax-Span-378" style="font-family: MathJax_Size2; vertical-align: 0em;">∑</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; clip: rect(3.412em, 1000.21em, 4.274em, -1000em); top: -2.939em; left: 0.6em;"><span class="mi" id="MathJax-Span-379" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">i</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mi" id="MathJax-Span-380" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.167em;">l</span><span class="mi" id="MathJax-Span-381" style="font-family: MathJax_Math; font-style: italic;">o</span><span class="mi" id="MathJax-Span-382" style="font-family: MathJax_Math; font-style: italic;">g<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mo" id="MathJax-Span-383" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-384"><span style="display: inline-block; position: relative; width: 1.116em; height: 0px;"><span style="position: absolute; clip: rect(3.437em, 1000.42em, 4.177em, -1000em); top: -4.023em; left: 0em;"><span class="mi" id="MathJax-Span-385" style="font-family: MathJax_Math; font-style: italic;">s</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.469em;"><span class="texatom" id="MathJax-Span-386"><span class="mrow" id="MathJax-Span-387"><span class="msubsup" id="MathJax-Span-388"><span style="display: inline-block; position: relative; width: 0.572em; height: 0px;"><span style="position: absolute; clip: rect(3.567em, 1000.35em, 4.312em, -1000em); top: -4.023em; left: 0em;"><span class="mi" id="MathJax-Span-389" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.004em;"></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.853em; left: 0.346em;"><span class="mi" id="MathJax-Span-390" style="font-size: 50%; font-family: MathJax_Math; font-style: italic;">i</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-391" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.438em; border-left: 0px solid; width: 0px; height: 2.596em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mrow class="MJX-TeXAtom-ORD"><mi class="MJX-tex-caligraphic" mathvariant="script">L</mi></mrow><mo stretchy="false">(</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">s</mi></mrow><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><munder><mo>∑</mo><mi>i</mi></munder><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mrow class="MJX-TeXAtom-ORD"><msub><mi>y</mi><mi>i</mi></msub></mrow></msub><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-46">
\mathcal{L}(\mathbf{s}) = - \sum_i log(s_{y_i})
</script></p>

<p>For each example, this function simply plucks the class score’s value
at the known correct class and takes the negative log of it. So the
closer this score is to 1 (as in it’s correct), the closer the loss is
to 0, and the closer the score is to 0 (it’s wrong), the larger the
loss. The cross entropy loss thus serves as a function that quantifies
how badly the score function behaves on known data.</p>

<p>Now that we have a loss function that measures the quality of our
classifier, all we have left to do is to find parameters (weights and
biases) that minimise this loss. This is a classic <em>optimisation
problem</em> and in the practical example we’re going to see soon, we use
a method called <a href="https://en.wikipedia.org/wiki/Stochastic_gradient_descent">stochastic gradient
descent</a> for this.</p>

<p>To get a feeling for the method, let’s consider a simpler loss
function that has only one parameter, <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-47-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;w&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-392" style="width: 0.864em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.718em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.76em, 1000.69em, 2.501em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-393"><span class="mi" id="MathJax-Span-394" style="font-family: MathJax_Math; font-style: italic;">w</span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.068em; border-left: 0px solid; width: 0px; height: 0.638em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>w</mi></math></span></span><script type="math/tex" id="MathJax-Element-47">w</script>. It looks something like the
bowl in the figure below, and we’re trying to find this
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-48-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;w&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;o&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;p&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;t&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;i&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;m&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;a&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;l&lt;/mi&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-395" style="width: 3.69em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.161em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.616em, 1003.16em, 2.634em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-396"><span class="msubsup" id="MathJax-Span-397"><span style="display: inline-block; position: relative; width: 3.148em; height: 0px;"><span style="position: absolute; clip: rect(3.436em, 1000.69em, 4.178em, -1000em); top: -4.023em; left: 0em;"><span class="mi" id="MathJax-Span-398" style="font-family: MathJax_Math; font-style: italic;">w</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.716em;"><span class="texatom" id="MathJax-Span-399"><span class="mrow" id="MathJax-Span-400"><span class="texatom" id="MathJax-Span-401"><span class="mrow" id="MathJax-Span-402"><span class="mi" id="MathJax-Span-403" style="font-size: 70.7%; font-family: MathJax_Main;">o</span><span class="mi" id="MathJax-Span-404" style="font-size: 70.7%; font-family: MathJax_Main;">p</span><span class="mi" id="MathJax-Span-405" style="font-size: 70.7%; font-family: MathJax_Main;">t</span><span class="mi" id="MathJax-Span-406" style="font-size: 70.7%; font-family: MathJax_Main;">i</span><span class="mi" id="MathJax-Span-407" style="font-size: 70.7%; font-family: MathJax_Main;">m</span><span class="mi" id="MathJax-Span-408" style="font-size: 70.7%; font-family: MathJax_Main;">a</span><span class="mi" id="MathJax-Span-409" style="font-size: 70.7%; font-family: MathJax_Main;">l</span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.389em; border-left: 0px solid; width: 0px; height: 0.958em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>w</mi><mrow class="MJX-TeXAtom-ORD"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="normal">o</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">l</mi></mrow></mrow></msub></math></span></span><script type="math/tex" id="MathJax-Element-48">w_{\mathrm{optimal}}</script> where the loss <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-49-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;&gt;L&lt;/mi&gt;&lt;/mrow&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mi&gt;w&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-410" style="width: 2.589em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.203em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.453em, 1002.11em, 2.74em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-411"><span class="texatom" id="MathJax-Span-412"><span class="mrow" id="MathJax-Span-413"><span class="mi" id="MathJax-Span-414" style="font-family: MathJax_Caligraphic;">L</span></span></span><span class="mo" id="MathJax-Span-415" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-416" style="font-family: MathJax_Math; font-style: italic;">w</span><span class="mo" id="MathJax-Span-417" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.346em; border-left: 0px solid; width: 0px; height: 1.271em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi class="MJX-tex-caligraphic" mathvariant="script">L</mi></mrow><mo stretchy="false">(</mo><mi>w</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-49">\mathcal{L}(w)</script> is at the
bottom of the bowl.</p>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/gradient-descent.png" alt="A simplified look at gradient descent.">
  <figcaption>A simplified look at gradient descent.</figcaption>
</figure>


<p>Since we don’t know where this is to begin with, we start with a guess
at any point <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-50-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;w&lt;/mi&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-418" style="width: 1.343em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.149em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.616em, 1001.15em, 2.512em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-419"><span class="msubsup" id="MathJax-Span-420"><span style="display: inline-block; position: relative; width: 1.145em; height: 0px;"><span style="position: absolute; clip: rect(3.436em, 1000.69em, 4.178em, -1000em); top: -4.023em; left: 0em;"><span class="mi" id="MathJax-Span-421" style="font-family: MathJax_Math; font-style: italic;">w</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.716em;"><span class="mn" id="MathJax-Span-422" style="font-size: 70.7%; font-family: MathJax_Main;">0</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.248em; border-left: 0px solid; width: 0px; height: 0.817em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>w</mi><mn>0</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-50">w_0</script>. And then we feel around our local neighbourhood
and head in the downward direction of the slope. This gets us to the
point <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-51-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;w&lt;/mi&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-423" style="width: 1.343em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.149em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.616em, 1001.15em, 2.497em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-424"><span class="msubsup" id="MathJax-Span-425"><span style="display: inline-block; position: relative; width: 1.145em; height: 0px;"><span style="position: absolute; clip: rect(3.436em, 1000.69em, 4.178em, -1000em); top: -4.023em; left: 0em;"><span class="mi" id="MathJax-Span-426" style="font-family: MathJax_Math; font-style: italic;">w</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.716em;"><span class="mn" id="MathJax-Span-427" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.23em; border-left: 0px solid; width: 0px; height: 0.799em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>w</mi><mn>1</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-51">w_1</script>. Where we do this again, arriving at <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-52-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;w&lt;/mi&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-428" style="width: 1.343em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.149em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.616em, 1001.15em, 2.497em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-429"><span class="msubsup" id="MathJax-Span-430"><span style="display: inline-block; position: relative; width: 1.145em; height: 0px;"><span style="position: absolute; clip: rect(3.436em, 1000.69em, 4.178em, -1000em); top: -4.023em; left: 0em;"><span class="mi" id="MathJax-Span-431" style="font-family: MathJax_Math; font-style: italic;">w</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.716em;"><span class="mn" id="MathJax-Span-432" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.23em; border-left: 0px solid; width: 0px; height: 0.799em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>w</mi><mn>2</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-52">w_2</script>. And again and
again, until we reach a point where we can’t go any lower or the slope
is 0. This is when we’ve found <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-53-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mi&gt;w&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;o&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;p&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;t&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;i&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;m&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;a&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;l&lt;/mi&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-433" style="width: 3.69em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.161em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.616em, 1003.16em, 2.634em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-434"><span class="msubsup" id="MathJax-Span-435"><span style="display: inline-block; position: relative; width: 3.148em; height: 0px;"><span style="position: absolute; clip: rect(3.436em, 1000.69em, 4.178em, -1000em); top: -4.023em; left: 0em;"><span class="mi" id="MathJax-Span-436" style="font-family: MathJax_Math; font-style: italic;">w</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.716em;"><span class="texatom" id="MathJax-Span-437"><span class="mrow" id="MathJax-Span-438"><span class="texatom" id="MathJax-Span-439"><span class="mrow" id="MathJax-Span-440"><span class="mi" id="MathJax-Span-441" style="font-size: 70.7%; font-family: MathJax_Main;">o</span><span class="mi" id="MathJax-Span-442" style="font-size: 70.7%; font-family: MathJax_Main;">p</span><span class="mi" id="MathJax-Span-443" style="font-size: 70.7%; font-family: MathJax_Main;">t</span><span class="mi" id="MathJax-Span-444" style="font-size: 70.7%; font-family: MathJax_Main;">i</span><span class="mi" id="MathJax-Span-445" style="font-size: 70.7%; font-family: MathJax_Main;">m</span><span class="mi" id="MathJax-Span-446" style="font-size: 70.7%; font-family: MathJax_Main;">a</span><span class="mi" id="MathJax-Span-447" style="font-size: 70.7%; font-family: MathJax_Main;">l</span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.389em; border-left: 0px solid; width: 0px; height: 0.958em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>w</mi><mrow class="MJX-TeXAtom-ORD"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="normal">o</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">l</mi></mrow></mrow></msub></math></span></span><script type="math/tex" id="MathJax-Element-53">w_{\mathrm{optimal}}</script>.</p>

<p>This is shown in the equations alongside the figure, where we’ve now
introduced a parameter called the learning rate, <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-54-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;&amp;#x03B7;&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-448" style="width: 0.625em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.527em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.761em, 1000.53em, 2.706em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-449"><span class="mi" id="MathJax-Span-450" style="font-family: MathJax_Math; font-style: italic;">η<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.006em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.306em; border-left: 0px solid; width: 0px; height: 0.874em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>η</mi></math></span></span><script type="math/tex" id="MathJax-Element-54">\eta</script>. This is a
measure of how fast we modify our weights and is something that we
need to carefully tune in practice.</p>

<p>The actual mechanism for finding these slopes (or gradients when we
have multiple parameters) comes out of the box in TensorFlow as we’re
soon going to see. But if you’re interested in the details of how this
is done, you should go read about something called <a href="https://en.wikipedia.org/wiki/Automatic_differentiation"><em>backward mode
automatic differentiation</em></a>.</p>

<h4 id="notebook-1-a-linear-classifier-for-the-mnist-handwritten-digit-dataset-in-tensorflow">Notebook 1: A linear classifier for the MNIST handwritten digit dataset in TensorFlow</h4>

<p>Finally we have all the pieces to make our first complete learning
image classifier! Given some image as a raw array of numbers, we have
a parameterised score function (linear transformation followed by a
softmax function) that takes us to category scores. We have a way of
evaluating its performance (the cross entropy loss function). We also
have an algorithm to learn from example data and improve the
classifier’s parameters (optimisation via stochastic gradient
descent).</p>

<p>So let’s pause on the theory for a bit to go work out our <a href="https://github.com/hnarayanan/artistic-style-transfer/blob/master/notebooks/1_Linear_Image_Classifier.ipynb">first
practical example</a> in the form of an IPython
notebook. This example reproduces and expands upon <a href="https://www.tensorflow.org/get_started/mnist/beginners">the MNIST digit
classification tutorial on the TensorFlow
website</a> aimed at beginners to machine
learning. Working through this example will ensure that you have
TensorFlow running properly on your machine, and allows you to
experience coding up an image classifier to see all the pieces we
talked about in action.</p>

<p>Note that all the embedded code in this article also exists as a
<a href="https://github.com/hnarayanan/artistic-style-transfer">standalone GitHub repository</a> as a collection of iPython
notebooks. Apart from having all the code in one convenient place for
you to play with and extend, the repository also contains setup notes
on how to get started with the code. So do <a href="https://github.com/hnarayanan/artistic-style-transfer">fetch a copy</a>
and experiment alongside reading this article, it’ll really help
solidify concepts.</p>

<p>With that, let’s start by importing some packages we need.</p>

<pre><code class="language-python hljs"><span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf
<span class="hljs-keyword">from</span> tensorflow.examples.tutorials.mnist <span class="hljs-keyword">import</span> input_data

<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
%matplotlib inline
plt.rcParams[<span class="hljs-string">'figure.figsize'</span>] = (<span class="hljs-number">5.0</span>, <span class="hljs-number">4.0</span>)
plt.rcParams[<span class="hljs-string">'image.cmap'</span>] = <span class="hljs-string">'Greys'</span>

<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
np.set_printoptions(suppress=<span class="hljs-keyword">True</span>)
np.set_printoptions(precision=<span class="hljs-number">2</span>)
</code></pre>

<h5 id="getting-a-feel-for-the-data">Getting a feel for the data</h5>

<p>MNIST is a dataset that contains 70,000 labelled images of handwritten
digits that look like the following.</p>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/mnist-sample.png" alt="A sample of the MNIST handwritten dataset.">
  <figcaption>A sample of the MNIST handwritten dataset.</figcaption>
</figure>


<p>We’re going to train a linear classifier on a part of this dataset,
and test it against another portion of the dataset to see how well we
did.</p>

<p>The TensorFlow tutorial comes with a handy loader for this dataset.</p>

<pre><code class="language-python hljs">mnist = input_data.read_data_sets(<span class="hljs-string">"MNIST_data/"</span>, one_hot=<span class="hljs-keyword">True</span>)
</code></pre>

<pre><code class="hljs nginx"><span class="hljs-title">Extracting</span> MNIST_data/train-images-idx3-ubyte.gz
Extracting MNIST_data/train-labels-idx1-ubyte.gz
Extracting MNIST_data/t10k-images-idx3-ubyte.gz
Extracting MNIST_data/t10k-labels-idx1-ubyte.gz
</code></pre>

<p>The loader even handily splits the dataset into three parts:</p>

<ul>
<li>A training set (55000 examples) used to train the model</li>
<li>A validation set (5000 examples) used to optimise
hyperparameters. This is not discussed or used in this article.</li>
<li>A test set (10000 examples) used to gauge the accuracy of the trained model</li>
</ul>

<p>The images are greyscale and each 28 pixels wide by 28 pixels tall,
and this is stored as an array of length 784.</p>

<p>The labels are a <em>one hot</em> vector of length 10, meaning it is a vector
of all zeros except at the location that corresponds to the label it’s
referring to. E.g. An image with a label <code>3</code> will be represented as
<code>(0, 0, 0, 1, 0, 0, 0, 0, 0, 0)</code>.</p>

<pre><code class="language-python hljs"><span class="hljs-keyword">print</span> mnist.train.images.shape
<span class="hljs-keyword">print</span> mnist.train.labels.shape
</code></pre>

<pre><code class="hljs cpp">(<span class="hljs-number">55000</span>, <span class="hljs-number">784</span>)
(<span class="hljs-number">55000</span>, <span class="hljs-number">10</span>)
</code></pre>

<pre><code class="language-python hljs"><span class="hljs-keyword">print</span> mnist.test.images.shape
<span class="hljs-keyword">print</span> mnist.test.labels.shape
</code></pre>

<pre><code class="hljs cpp">(<span class="hljs-number">10000</span>, <span class="hljs-number">784</span>)
(<span class="hljs-number">10000</span>, <span class="hljs-number">10</span>)
</code></pre>

<p>We can get a better sense for one of these examples by visualising the
image and looking at the label.</p>

<pre><code class="language-python hljs">example_image = mnist.train.images[<span class="hljs-number">1</span>]
example_image_reshaped = example_image.reshape((<span class="hljs-number">28</span>, <span class="hljs-number">28</span>)) <span class="hljs-comment"># Can't render a line of 784 numbers</span>
example_label = mnist.train.labels[<span class="hljs-number">1</span>]

<span class="hljs-keyword">print</span> example_label
plt.imshow(example_image_reshaped)
</code></pre>

<pre><code class="hljs cpp">[ <span class="hljs-number">0.</span>  <span class="hljs-number">0.</span>  <span class="hljs-number">0.</span>  <span class="hljs-number">1.</span>  <span class="hljs-number">0.</span>  <span class="hljs-number">0.</span>  <span class="hljs-number">0.</span>  <span class="hljs-number">0.</span>  <span class="hljs-number">0.</span>  <span class="hljs-number">0.</span>]
</code></pre>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/output_9_2.png" alt="Visualising an example image in the dataset.">
  <figcaption>Visualising an example image in the dataset.</figcaption>
</figure>


<h5 id="setting-up-a-score-function-loss-function-and-optimisation-algorithm">Setting up a score function, loss function and optimisation algorithm</h5>

<p>Now that we have a better sense of the dataset we’re working with,
let’s move onto the machine learning bits.</p>

<p>First, we setup some placeholders to hold batches of this training
data for when we learn our model. The reason why we work in batches is
that it’s easier on memory than holding the entire set. And it’s this
notion of working with (random) batches of input rather than the
entire set that moves us from the realm of <em>Gradient Descent</em> that we
saw earlier, to <em>Stochastic Gradient Descent</em> that we have here.</p>

<pre><code class="language-python hljs">x = tf.placeholder(tf.float32, [<span class="hljs-keyword">None</span>, <span class="hljs-number">784</span>])
y_ = tf.placeholder(tf.float32, [<span class="hljs-keyword">None</span>, <span class="hljs-number">10</span>])
</code></pre>

<p>We define our linear model for the score function after introducing
two of parameters, <strong>W</strong> and <strong>b</strong>.</p>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/linear.svg" alt="A schematic of a linear model.">
  <figcaption>A schematic of a linear model.</figcaption>
</figure>


<pre><code class="language-python hljs">W = tf.Variable(tf.zeros([<span class="hljs-number">784</span>, <span class="hljs-number">10</span>]))
b = tf.Variable(tf.zeros([<span class="hljs-number">10</span>]))
y = tf.nn.softmax(tf.matmul(x, W) + b)
</code></pre>

<p>We define our loss function to measure how poorly this model performs
on images with known labels. We use the a specific form called the
<a href="https://jamesmccaffrey.wordpress.com/2013/11/05/why-you-should-use-cross-entropy-error-instead-of-classification-error-or-mean-squared-error-for-neural-network-classifier-training/">cross entropy loss</a>.</p>

<pre><code class="language-python hljs">cross_entropy = tf.reduce_mean(-tf.reduce_sum(y_*tf.log(y), reduction_indices=[<span class="hljs-number">1</span>]))
</code></pre>

<p>Using the magic of blackbox optimisation algorithms provided by
TensorFlow, we can define a single step of the stochastic gradient
descent optimiser (to improve our parameters for our score function
and reduce the loss) in one line of code.</p>

<pre><code class="language-python hljs">train_step = tf.train.GradientDescentOptimizer(<span class="hljs-number">0.5</span>).minimize(cross_entropy)
</code></pre>

<h5 id="training-the-model">Training the model</h5>

<p>The way TensorFlow works, we haven’t really executed any of the code 
above in the classic sense. All we’ve done is defined what’s called the 
computational graph.</p>

<p>Now we go ahead and initialise a session to actually train the model and evaluate its performance.</p>

<pre><code class="language-python hljs">init = tf.global_variables_initializer()
sess = tf.Session()
sess.run(init)
</code></pre>

<p>We train the model iteratively for 1000 steps, loading a batch of example images each time.</p>

<pre><code class="language-python hljs"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1000</span>):
  batch_xs, batch_ys = mnist.train.next_batch(<span class="hljs-number">100</span>)
  sess.run(train_step, feed_dict={x: batch_xs, y_: batch_ys})
</code></pre>

<h5 id="verifying-the-results">Verifying the results</h5>

<p>At this point, our model is trained. And we can deterime in the
<em>accuracy</em> by passing in all the test images and labels, figuring out
our own labels, and averaging out the results.</p>

<pre><code class="language-python hljs">correct_prediction = tf.equal(tf.argmax(y, <span class="hljs-number">1</span>), tf.argmax(y_, <span class="hljs-number">1</span>))
accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))
print(sess.run(accuracy, feed_dict={x: mnist.test.images, y_: mnist.test.labels}))
</code></pre>

<pre><code class="hljs cpp"><span class="hljs-number">0.9205</span>
</code></pre>

<p>Around 92%, that’s pretty good!</p>

<h3 id="moving-to-neural-networks">Moving to neural networks</h3>

<p>The linear image classifier we just built works surprisingly well for
the <a href="http://yann.lecun.com/exdb/mnist/">MNIST digit dataset</a> (around 92% accurate). I
think <em>this is pretty amazing</em>, because what this implies is that
these images are (mostly) linearly separable in the 784 dimensional
space that they’re represented in. Meaning you can draw 10 lines
(<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-55-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;mo&gt;&amp;#x2212;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-451" style="width: 2.684em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.299em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.537em, 1002.23em, 2.572em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-452"><span class="mi" id="MathJax-Span-453" style="font-family: MathJax_Math; font-style: italic;">n</span><span class="mo" id="MathJax-Span-454" style="font-family: MathJax_Main; padding-left: 0.222em;">−</span><span class="mn" id="MathJax-Span-455" style="font-family: MathJax_Main; padding-left: 0.222em;">1</span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.151em; border-left: 0px solid; width: 0px; height: 0.979em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi><mo>−</mo><mn>1</mn></math></span></span><script type="math/tex" id="MathJax-Element-55">n-1</script> dimensional hyperplanes, really) in a plane (<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-56-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-456" style="width: 0.721em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.623em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.761em, 1000.6em, 2.501em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-457"><span class="mi" id="MathJax-Span-458" style="font-family: MathJax_Math; font-style: italic;">n</span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.068em; border-left: 0px solid; width: 0px; height: 0.637em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>n</mi></math></span></span><script type="math/tex" id="MathJax-Element-56">n</script> dimensional
space, really) with these digits and neatly separate them into
categories.</p>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/mnist-tsne.png" alt="A t-SNE plot of the MNIST dataset that attempts to represent the digits in a 2D plane while preserving the topology of the data. (Reproduced from Maaten and Hinton, 2008.)">
  <figcaption>A t-SNE plot of the MNIST dataset that attempts to 
represent the digits in a 2D plane while preserving the topology of the 
data. (Reproduced from Maaten and Hinton, 2008.)</figcaption>
</figure>


<p>But if you read the <a href="https://www.tensorflow.org/get_started/mnist/beginners">TensorFlow tutorial</a>
that deals with the same dataset, they explicitly point out that:</p>

<blockquote>
<p>“Getting 92% accuracy on MNIST is bad. It’s almost embarrassingly
  bad.”</p>
</blockquote>

<p>So if you’re like the author of this tutorial and want to improve the
performance of our classifier (or handle a more general dataset beyond
neatly normalised greyscale digits) we need to move to a more
general, nonlinear score function. The cool thing is that as we
generalise the score function, the rest of the machinery (the loss
function and optimisation process) stays the same!</p>

<h4 id="making-the-score-function-nonlinear">Making the score function nonlinear</h4>

<p>To make the score function nonlinear, we first introduce what’s called
a <em>neuron</em>. This is the simple function shown in the <a href="https://appliedgo.net/perceptron/">following
animation</a> that does three things:</p>

<ol>
<li>It multiplies each of its inputs by a weight.</li>
<li>It sums these weighted inputs to a single number and adds a bias.</li>
<li>It passes this number through a nonlinear function called the
<em>activation</em> and produces an output.</li>
</ol>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/neuron.gif" alt="An artificial neuron. (Reproduced from https://appliedgo.net/perceptron/)">
  <figcaption>An artificial neuron. (Reproduced from https://appliedgo.net/perceptron/)</figcaption>
</figure>


<p>These neurons can be arranged into layers to form a <em>neural network</em>
that on the outer layers match the shape of our input and our
output. For the MNIST dataset that we’ve been working with, this is a
vector of 784 numbers coming in and 10 numbers going out. The layer
in the middle is called the <em>hidden layer</em> since we don’t directly
access it on the input or the output. It can be of arbitrary size, and
this is the sort of thing that defines the <em>architecture of the
network</em>. In neural network parlance the network shown below is called
a <em>two layer network</em> or a <em>one hidden layer network</em>. (We can have as
many of these hidden layers as we need.)</p>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/neural-network-1-hidden.svg" alt="Stacking neurons into a neural network with one hidden layer.">
  <figcaption>Stacking neurons into a neural network with one hidden layer.</figcaption>
</figure>


<p>By stacking neurons in this fashion, we can express in a
straightforward manner the operations performed by the network in
matrix-vector notation:</p>

<ol>
<li>It takes in an input vector <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-57-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-459" style="width: 0.721em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.623em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.615em, 1000.6em, 2.347em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-460"><span class="texatom" id="MathJax-Span-461"><span class="mrow" id="MathJax-Span-462"><span class="mi" id="MathJax-Span-463" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.626em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-57">\mathbf{x}</script>.</li>
<li>The hidden layer first performs a linear operation with some
weights and biases,
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-58-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;y&lt;/mi&gt;&lt;/mrow&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;W&lt;/mi&gt;&lt;/mrow&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;b&lt;/mi&gt;&lt;/mrow&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-464" style="width: 8.336em; display: inline-block;"><span style="display: inline-block; position: relative; width: 7.184em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.413em, 1007.12em, 2.63em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-465"><span class="msubsup" id="MathJax-Span-466"><span style="display: inline-block; position: relative; width: 1.036em; height: 0px;"><span style="position: absolute; clip: rect(3.435em, 1000.58em, 4.367em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-467"><span class="mrow" id="MathJax-Span-468"><span class="mi" id="MathJax-Span-469" style="font-family: MathJax_Main; font-weight: bold;">y</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.788em; left: 0.607em;"><span class="mn" id="MathJax-Span-470" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-471" style="font-family: MathJax_Main; padding-left: 0.278em;">=</span><span class="msubsup" id="MathJax-Span-472" style="padding-left: 0.278em;"><span style="display: inline-block; position: relative; width: 1.618em; height: 0px;"><span style="position: absolute; clip: rect(3.193em, 1001.16em, 4.174em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-473"><span class="mrow" id="MathJax-Span-474"><span class="mi" id="MathJax-Span-475" style="font-family: MathJax_Main; font-weight: bold;">W</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 1.189em;"><span class="mn" id="MathJax-Span-476" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="texatom" id="MathJax-Span-477"><span class="mrow" id="MathJax-Span-478"><span class="mi" id="MathJax-Span-479" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span><span class="mo" id="MathJax-Span-480" style="font-family: MathJax_Main; padding-left: 0.222em;">+</span><span class="msubsup" id="MathJax-Span-481" style="padding-left: 0.222em;"><span style="display: inline-block; position: relative; width: 1.068em; height: 0px;"><span style="position: absolute; clip: rect(3.185em, 1000.6em, 4.173em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-482"><span class="mrow" id="MathJax-Span-483"><span class="mi" id="MathJax-Span-484" style="font-family: MathJax_Main; font-weight: bold;">b</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.639em;"><span class="mn" id="MathJax-Span-485" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-486" style="font-family: MathJax_Main;">,</span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.329em; border-left: 0px solid; width: 0px; height: 1.189em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">y</mi></mrow><mn>1</mn></msub><mo>=</mo><msub><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">W</mi></mrow><mn>1</mn></msub><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow><mo>+</mo><msub><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">b</mi></mrow><mn>1</mn></msub><mo>,</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-58">
\mathbf{y}_1 = \mathbf{W}_1 \mathbf{x} + \mathbf{b}_1,
</script>
followed by the simplest possible nonlinearity we can
imagine, a piece-wise linear function called <a href="https://en.wikipedia.org/wiki/Rectifier_(neural_networks)">rectified linear
unit</a> (ReLU):
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-59-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;h&lt;/mi&gt;&lt;/mrow&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mo movablelimits=&quot;true&quot; form=&quot;prefix&quot;&gt;max&lt;/mo&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mn&gt;0&lt;/mn&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;y&lt;/mi&gt;&lt;/mrow&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;.&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-487" style="width: 8.479em; display: inline-block;"><span style="display: inline-block; position: relative; width: 7.28em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.357em, 1007.2em, 2.645em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-488"><span class="msubsup" id="MathJax-Span-489"><span style="display: inline-block; position: relative; width: 1.068em; height: 0px;"><span style="position: absolute; clip: rect(3.185em, 1000.62em, 4.167em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-490"><span class="mrow" id="MathJax-Span-491"><span class="mi" id="MathJax-Span-492" style="font-family: MathJax_Main; font-weight: bold;">h</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.639em;"><span class="mn" id="MathJax-Span-493" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-494" style="font-family: MathJax_Main; padding-left: 0.278em;">=</span><span class="mo" id="MathJax-Span-495" style="font-family: MathJax_Main; padding-left: 0.278em;">max</span><span class="mo" id="MathJax-Span-496" style="font-family: MathJax_Main;">(</span><span class="mn" id="MathJax-Span-497" style="font-family: MathJax_Main;">0</span><span class="mo" id="MathJax-Span-498" style="font-family: MathJax_Main;">,</span><span class="msubsup" id="MathJax-Span-499" style="padding-left: 0.167em;"><span style="display: inline-block; position: relative; width: 1.036em; height: 0px;"><span style="position: absolute; clip: rect(3.435em, 1000.58em, 4.367em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-500"><span class="mrow" id="MathJax-Span-501"><span class="mi" id="MathJax-Span-502" style="font-family: MathJax_Main; font-weight: bold;">y</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.788em; left: 0.607em;"><span class="mn" id="MathJax-Span-503" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-504" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-505" style="font-family: MathJax_Main;">.</span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.346em; border-left: 0px solid; width: 0px; height: 1.271em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">h</mi></mrow><mn>1</mn></msub><mo>=</mo><mo movablelimits="true" form="prefix">max</mo><mo stretchy="false">(</mo><mn>0</mn><mo>,</mo><msub><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">y</mi></mrow><mn>1</mn></msub><mo stretchy="false">)</mo><mo>.</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-59">
\mathbf{h}_1 = \max(0, \mathbf{y}_1).
</script>
(There are many other <a href="http://cs231n.github.io/neural-networks-1/#actfun">functional forms</a> one
could use for this nonlinear activation function, but this one form is
really popular todayand will suffice for our needs.)</li>
<li>Finally we stack an additional matrix-vector linear operation
(introducing another set of weights and biases) to bring our output
back to the size we want, 10 numbers going out.
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-60-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;y&lt;/mi&gt;&lt;/mrow&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;W&lt;/mi&gt;&lt;/mrow&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msub&gt;&lt;msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;h&lt;/mi&gt;&lt;/mrow&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;/msub&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;b&lt;/mi&gt;&lt;/mrow&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msub&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-506" style="width: 8.527em; display: inline-block;"><span style="display: inline-block; position: relative; width: 7.328em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.413em, 1007.33em, 2.63em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-507"><span class="msubsup" id="MathJax-Span-508"><span style="display: inline-block; position: relative; width: 1.036em; height: 0px;"><span style="position: absolute; clip: rect(3.435em, 1000.58em, 4.367em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-509"><span class="mrow" id="MathJax-Span-510"><span class="mi" id="MathJax-Span-511" style="font-family: MathJax_Main; font-weight: bold;">y</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.788em; left: 0.607em;"><span class="mn" id="MathJax-Span-512" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-513" style="font-family: MathJax_Main; padding-left: 0.278em;">=</span><span class="msubsup" id="MathJax-Span-514" style="padding-left: 0.278em;"><span style="display: inline-block; position: relative; width: 1.618em; height: 0px;"><span style="position: absolute; clip: rect(3.193em, 1001.16em, 4.174em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-515"><span class="mrow" id="MathJax-Span-516"><span class="mi" id="MathJax-Span-517" style="font-family: MathJax_Main; font-weight: bold;">W</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 1.189em;"><span class="mn" id="MathJax-Span-518" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-519"><span style="display: inline-block; position: relative; width: 1.068em; height: 0px;"><span style="position: absolute; clip: rect(3.185em, 1000.62em, 4.167em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-520"><span class="mrow" id="MathJax-Span-521"><span class="mi" id="MathJax-Span-522" style="font-family: MathJax_Main; font-weight: bold;">h</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.639em;"><span class="mn" id="MathJax-Span-523" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-524" style="font-family: MathJax_Main; padding-left: 0.222em;">+</span><span class="msubsup" id="MathJax-Span-525" style="padding-left: 0.222em;"><span style="display: inline-block; position: relative; width: 1.068em; height: 0px;"><span style="position: absolute; clip: rect(3.185em, 1000.6em, 4.173em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-526"><span class="mrow" id="MathJax-Span-527"><span class="mi" id="MathJax-Span-528" style="font-family: MathJax_Main; font-weight: bold;">b</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.639em;"><span class="mn" id="MathJax-Span-529" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.329em; border-left: 0px solid; width: 0px; height: 1.189em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">y</mi></mrow><mn>2</mn></msub><mo>=</mo><msub><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">W</mi></mrow><mn>2</mn></msub><msub><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">h</mi></mrow><mn>1</mn></msub><mo>+</mo><msub><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">b</mi></mrow><mn>2</mn></msub></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-60">
\mathbf{y}_2 = \mathbf{W}_2 \mathbf{h}_1 + \mathbf{b}_2
</script>
As before, we pass this output through a <a href="https://en.wikipedia.org/wiki/Softmax_function">softmax</a> function
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-61-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;&amp;#x03C3;&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-530" style="width: 0.673em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.575em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.772em, 1000.58em, 2.501em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-531"><span class="mi" id="MathJax-Span-532" style="font-family: MathJax_Math; font-style: italic;">σ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.001em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.068em; border-left: 0px solid; width: 0px; height: 0.624em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>σ</mi></math></span></span><script type="math/tex" id="MathJax-Element-61">\sigma</script> so that we an interpret the output as the probability of each
category.
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-62-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;s&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mi&gt;&amp;#x03C3;&lt;/mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;y&lt;/mi&gt;&lt;/mrow&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-533" style="width: 4.84em; display: inline-block;"><span style="display: inline-block; position: relative; width: 4.167em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.453em, 1004.07em, 2.74em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-534"><span class="texatom" id="MathJax-Span-535"><span class="mrow" id="MathJax-Span-536"><span class="mi" id="MathJax-Span-537" style="font-family: MathJax_Main; font-weight: bold;">s</span></span></span><span class="mo" id="MathJax-Span-538" style="font-family: MathJax_Main; padding-left: 0.278em;">=</span><span class="mi" id="MathJax-Span-539" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.278em;">σ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.001em;"></span></span><span class="mo" id="MathJax-Span-540" style="font-family: MathJax_Main;">(</span><span class="msubsup" id="MathJax-Span-541"><span style="display: inline-block; position: relative; width: 1.036em; height: 0px;"><span style="position: absolute; clip: rect(3.435em, 1000.58em, 4.367em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-542"><span class="mrow" id="MathJax-Span-543"><span class="mi" id="MathJax-Span-544" style="font-family: MathJax_Main; font-weight: bold;">y</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.788em; left: 0.607em;"><span class="mn" id="MathJax-Span-545" style="font-size: 70.7%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-546" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.346em; border-left: 0px solid; width: 0px; height: 1.271em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">s</mi></mrow><mo>=</mo><mi>σ</mi><mo stretchy="false">(</mo><msub><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">y</mi></mrow><mn>2</mn></msub><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-62">
\mathbf{s} = \sigma(\mathbf{y}_2)
</script></li>
</ol>

<p>And that’s all there is really to neural networks. If you stare at
them closely, you’ll see that they’re just collections of matrix
multiplications interwoven with element-wise nonlinear activation
functions.</p>

<h4 id="notebooks-2-3-a-neural-network-based-mnist-digit-classifier-in-tensorflow">Notebooks 2 &amp; 3: A neural network-based MNIST digit classifier in TensorFlow</h4>

<p>If you start digging into neural network theory, you’ll stumble across
the fact that the one hidden layer network architecture we just
introduced can <em><a href="https://en.wikipedia.org/wiki/Universal_approximation_theorem">approximate any functional
form</a></em>. Now, much like the fact that
the linear classifier worked at all, this seems like a mind-blowing
result. But if you look at the proofs for this a bit closer you’ll
realise that they cheat with having as many neurons as they need in
the hidden layer. Because then you can <a href="http://neuralnetworksanddeeplearning.com/chap4.html">apply Weierstrass
approximation theorem</a> or whatever and
you’re done.</p>

<p>We’ll spend some time later getting a better feeling for the
representative power of neural networks in general, but for now, let’s
pause with theory and return to our practical example. We’re going to
extend our linear image classifier to one based on a neural network,
and hopefully see <em>amazing gains</em> in classification accuracy in the
process!</p>

<p>The code for this extension is developed across two new notebooks in
the accompanying repository: <a href="https://github.com/hnarayanan/artistic-style-transfer/blob/master/notebooks/2_Neural_Network-based_Image_Classifier-1.ipynb">Notebook 2</a> and <a href="https://github.com/hnarayanan/artistic-style-transfer/blob/master/notebooks/3_Neural_Network-based_Image_Classifier-2.ipynb">Notebook
3</a>. Since the actual code changes relative to the linear
classifier are minimal (we’re only replacing the score function with a
nonlinear version after all), I’m only going to step through the
differences and their implications in what follows. Feel free to go
through the <a href="https://github.com/hnarayanan/artistic-style-transfer">notebooks in their entirety</a> if you would like
more context.</p>

<p>Recall that in the linear case we saw previously, the model for the
score function was:</p>

<pre><code class="language-python hljs">W = tf.Variable(tf.zeros([<span class="hljs-number">784</span>, <span class="hljs-number">10</span>]))
b = tf.Variable(tf.zeros([<span class="hljs-number">10</span>]))
y = tf.nn.softmax(tf.matmul(x, W) + b)
</code></pre>

<p>Now we redefine this to be a nonlinear model with a few additional
lines of code. Our new model is the one hidden layer network
architecture we saw earlier. This introduces two sets of parameters:
<strong>W1</strong>, <strong>b1</strong> and <strong>W2</strong>, <strong>b2</strong> that we need to learn.</p>

<pre><code class="language-python hljs">W1 = tf.Variable(tf.zeros([<span class="hljs-number">784</span>, <span class="hljs-number">100</span>]))
b1 = tf.Variable(tf.zeros([<span class="hljs-number">100</span>]))
h1 = tf.nn.relu(tf.matmul(x, W1) + b1)

W2 = tf.Variable(tf.zeros([<span class="hljs-number">100</span>, <span class="hljs-number">10</span>]))
b2 = tf.Variable(tf.zeros([<span class="hljs-number">10</span>]))
y = tf.nn.softmax(tf.matmul(h1, W2) + b2)
</code></pre>

<p>As before, we then define the cross entropy loss function that
quantifies how poorly his model performs on images with known labels
and use the stochastic gradient descent optimiser to iteratively
improve parameters and minimise the loss. And once this model is
trained, we can pass it test images and labels and determine the
average accuracy.</p>

<pre><code class="language-python hljs">correct_prediction = tf.equal(tf.argmax(y, <span class="hljs-number">1</span>), tf.argmax(y_, <span class="hljs-number">1</span>))
accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))
print(sess.run(accuracy, feed_dict={x: mnist.test.images, y_: mnist.test.labels}))
</code></pre>

<pre><code class="hljs cpp"><span class="hljs-number">0.1135</span>
</code></pre>

<p>11%?!? We expected to see amazing gains over 92% in our accuracy, but
instead see something terrible. <em>Why?</em> Why after all this talk of
universal approximators is our outcome so poor?</p>

<p>It turns out that <em>just because our score function can theoretically
fit anything doesn’t mean our learning algorithm can always find this
fit</em>. And if you look at the model definition code above from
<a href="https://github.com/hnarayanan/artistic-style-transfer/blob/master/notebooks/2_Neural_Network-based_Image_Classifier-1.ipynb">Notebook 2</a>, you’ll realise that this is because we
initialised all our weights and biases to 0. And it just so happens
that because of the way ReLUs are defined, starting everything at 0
means that they’re <em>dead</em> (or don’t fire) from the get-go, and
gradient descent can’t really modify and improve upon the parameters.</p>

<p>This explains the output of 10—11% accuracy, which is basically what
you’d get if you guessed at random between 10 possible categories. So
what we need to do is to improve the initialisation of these
parameters as we’ve done in <a href="https://github.com/hnarayanan/artistic-style-transfer/blob/master/notebooks/3_Neural_Network-based_Image_Classifier-2.ipynb">Notebook 3</a>.</p>

<pre><code class="language-python hljs">W1 = tf.Variable(tf.truncated_normal(shape=[<span class="hljs-number">784</span>, <span class="hljs-number">100</span>], stddev=<span class="hljs-number">0.1</span>))
b1 = tf.Variable(tf.constant(<span class="hljs-number">0.1</span>, shape=[<span class="hljs-number">100</span>]))
h1 = tf.nn.relu(tf.matmul(x, W1) + b1)

W2 = tf.Variable(tf.truncated_normal(shape=[<span class="hljs-number">100</span>, <span class="hljs-number">10</span>], stddev=<span class="hljs-number">0.1</span>))
b2 = tf.Variable(tf.constant(<span class="hljs-number">0.1</span>, shape=[<span class="hljs-number">10</span>]))
y = tf.nn.softmax(tf.matmul(h1, W2) + b2)
</code></pre>

<p>We initialise the weights with
<a href="https://www.tensorflow.org/api_docs/python/tf/random/truncated_normal">truncated normals</a> (literally picking values
from a normal distribution that’s been truncated to within two
standard deviations around the mean) and initialise biases to a small
positive constant, 0.1.</p>

<p>With this seemingly trivial change, retraining the model and verifying
its average accuracy on the test data tells a very different story.</p>

<pre><code class="language-python hljs">correct_prediction = tf.equal(tf.argmax(y, <span class="hljs-number">1</span>), tf.argmax(y_, <span class="hljs-number">1</span>))
accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))
print(sess.run(accuracy, feed_dict={x: mnist.test.images, y_: mnist.test.labels}))
</code></pre>

<pre><code class="hljs cpp"><span class="hljs-number">0.9654</span>
</code></pre>

<p>Over 96% accurate! Much better.</p>

<h3 id="and-finally-convolutional-neural-networks">And finally, convolutional neural networks</h3>

<p>We’re in a really good place right now in terms of our understanding
and capability. We’ve managed to build a (two-layer) neural network
that does an excellent job of classifying images. (Over 96% on the
MNIST data.) You would’ve also noticed that this extension didn’t take
too much more code than the linear classifier we built initially.</p>

<p>If I were to ask you now how we could further improve the accuracy of
our classifier, you’d probably point out that this is easy to do by
adding more layers to our score function (i.e. making our model
<em>deeper</em>). Perhaps something like the following:</p>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/neural-network-2-hidden.svg" alt="A neural network with two hidden layers.">
  <figcaption>A neural network with two hidden layers.</figcaption>
</figure>


<p>TODO: Insert somewhere around here the story about using the
TensorFlow playground to get a feeling for the representative power of
neural nets. That they can automatically learn features we’d need to
otherwise hand engineer.</p>

<p>The intuition being that even though each neuron is barely nonlinear,
introducing more layers of them allows for more nonlinearity,
increasing the approximation capability of the score function. While
this is indeed true, there are some fundamental drawbacks with the
general form of neural networks we’ve seen so far (the term for them
is <em>standard</em> or <em>fully-connected neural networks</em>):</p>

<p>Firstly, they entirely disregard the 2D structure of the image at the
get-go. Remember that instead of working with the input as <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-63-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mn&gt;28&lt;/mn&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mn&gt;28&lt;/mn&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-547" style="width: 3.738em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.209em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.441em, 1003.17em, 2.417em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-548"><span class="mn" id="MathJax-Span-549" style="font-family: MathJax_Main;">28</span><span class="mo" id="MathJax-Span-550" style="font-family: MathJax_Main; padding-left: 0.222em;">×</span><span class="mn" id="MathJax-Span-551" style="font-family: MathJax_Main; padding-left: 0.222em;">28</span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.081em; border-left: 0px solid; width: 0px; height: 0.909em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>28</mn><mo>×</mo><mn>28</mn></math></span></span><script type="math/tex" id="MathJax-Element-63">28 \times
28</script> matrix, they worked with the input as a 784 number array. And you
can imagine there is some useful information in pixels sharing
proximity that’s being lost.</p>

<figure>
  <img class="pure-img-three-fourths-width" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/image-to-array.png" alt="Fully-connected neural networks disregard the structure of the image.">
  <figcaption>Fully-connected neural networks disregard the structure of the image.</figcaption>
</figure>


<p>Secondly, the number of parameters we would need to learn grows really
rapidly as we add more layers. Here are the number of parameters
corresponding to the examples we’ve seen so far:</p>

<ul>
<li><strong>Linear:</strong> 784*10 + 10 = 7,850</li>
<li><strong>Neural network (one hidden layer):</strong> 784*100 + 100 + 100*10 + 10 = 79,510</li>
<li><strong>Neural network (two hidden layers):</strong> 784*400 + 400 + 400*100 + 100 + 100*10 + 10 = 355,110</li>
</ul>

<p>The fundamental reason for this rapid growth in parameters is that
every neuron in a given layer sees all neurons in the previous
layer. Furthermore, you can imagine how much worse this would be if
our input image wasn’t tiny (28&nbsp;px <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-64-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-552" style="width: 0.912em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.766em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.616em, 1000.62em, 2.386em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-553"><span class="mo" id="MathJax-Span-554" style="font-family: MathJax_Main;">×</span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.045em; border-left: 0px solid; width: 0px; height: 0.67em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo>×</mo></math></span></span><script type="math/tex" id="MathJax-Element-64">\times</script> 28&nbsp;px) but
instead more realistically sized.</p>

<p>Convolutional neural networks (convnets) are architected to solve both
these issues, making them particularly powerful for dealing with image
data. And we’ll soon see how we can use them to build a deep image
classifier that’s state of the art.</p>

<h4 id="architecture-of-convnets-in-general">Architecture of convnets in general</h4>

<p>Convnets are very similar to fully-connected neural networks in that
they’re made up of neurons arranged in layers and they have learnable
weights and biases. Each neuron receives some inputs, does a linear
map and optionally follows it with a nonlinear activation. The whole
network still expresses a single score function: from the raw image
pixels on one end to class scores at the other.</p>

<p>The thing that makes convnets special is that they make the explicit
assumptions on the structure of the input, in our case images, that
allow them to encode certain nice properties in their
architecture. These choices make them efficient to implement and
vastly reduce the amount of parameters in the network as we’ll soon
see.</p>

<p>TODO: Figure of the differences between standard and convolutional
neural networks.</p>

<p>Instead of dealing with the input data (and arranging intermediate
layers of neurons) as linear arrays, they deal with information as 3D
volumes (with width, height and depth). i.e. Every layer takes as
input a 3D volume of numbers and outputs a 3D volume of numbers. What
one imagines as a 2D input image (<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-65-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;W&lt;/mi&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mi&gt;H&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-555" style="width: 3.69em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.161em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.52em, 1003.16em, 2.512em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-556"><span class="mi" id="MathJax-Span-557" style="font-family: MathJax_Math; font-style: italic;">W<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.104em;"></span></span><span class="mo" id="MathJax-Span-558" style="font-family: MathJax_Main; padding-left: 0.222em;">×</span><span class="mi" id="MathJax-Span-559" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">H<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.057em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.081em; border-left: 0px solid; width: 0px; height: 0.929em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>W</mi><mo>×</mo><mi>H</mi></math></span></span><script type="math/tex" id="MathJax-Element-65">W \times H</script>) gets transformed into
3D by introducing the colour depth as the third dimension (<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-66-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;W&lt;/mi&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mi&gt;H&lt;/mi&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mi&gt;d&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-560" style="width: 5.702em; display: inline-block;"><span style="display: inline-block; position: relative; width: 4.885em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.509em, 1004.89em, 2.512em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-561"><span class="mi" id="MathJax-Span-562" style="font-family: MathJax_Math; font-style: italic;">W<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.104em;"></span></span><span class="mo" id="MathJax-Span-563" style="font-family: MathJax_Main; padding-left: 0.222em;">×</span><span class="mi" id="MathJax-Span-564" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">H<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.057em;"></span></span><span class="mo" id="MathJax-Span-565" style="font-family: MathJax_Main; padding-left: 0.222em;">×</span><span class="mi" id="MathJax-Span-566" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">d<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.081em; border-left: 0px solid; width: 0px; height: 0.942em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>W</mi><mo>×</mo><mi>H</mi><mo>×</mo><mi>d</mi></math></span></span><script type="math/tex" id="MathJax-Element-66">W \times H
\times d</script>). (Recall that this for the MNIST digit data would be 1
because it’s greyscale, but for a colour RGB image the depth would be
3.) Similarly what one might imagine as a linear output of length <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-67-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-567" style="width: 0.912em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.766em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.498em, 1000.77em, 2.512em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-568"><span class="mi" id="MathJax-Span-569" style="font-family: MathJax_Math; font-style: italic;">C<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.081em; border-left: 0px solid; width: 0px; height: 0.954em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi></math></span></span><script type="math/tex" id="MathJax-Element-67">C</script>
is actually represented as <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-68-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mi&gt;C&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-570" style="width: 4.887em; display: inline-block;"><span style="display: inline-block; position: relative; width: 4.215em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.498em, 1004.22em, 2.512em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-571"><span class="mn" id="MathJax-Span-572" style="font-family: MathJax_Main;">1</span><span class="mo" id="MathJax-Span-573" style="font-family: MathJax_Main; padding-left: 0.222em;">×</span><span class="mn" id="MathJax-Span-574" style="font-family: MathJax_Main; padding-left: 0.222em;">1</span><span class="mo" id="MathJax-Span-575" style="font-family: MathJax_Main; padding-left: 0.222em;">×</span><span class="mi" id="MathJax-Span-576" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">C<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.045em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.081em; border-left: 0px solid; width: 0px; height: 0.954em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>1</mn><mo>×</mo><mn>1</mn><mo>×</mo><mi>C</mi></math></span></span><script type="math/tex" id="MathJax-Element-68">1 \times 1 \times C</script>.</p>

<p>Convnets do this with the help of two different layer types.</p>

<h5 id="convolutional-conv-layer">Convolutional (Conv) layer</h5>

<p>The first is the <em>convolutional (Conv) layer</em>, and you can think of it
as a set of learnable filters. Let’s say we have <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-69-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-577" style="width: 1.056em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.91em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.52em, 1000.91em, 2.49em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-578"><span class="mi" id="MathJax-Span-579" style="font-family: MathJax_Math; font-style: italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.04em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.903em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>K</mi></math></span></span><script type="math/tex" id="MathJax-Element-69">K</script> such
filters. Each filter is small spatially, with an extent denoted by
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-70-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;F&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-580" style="width: 0.912em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.766em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.523em, 1000.77em, 2.49em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-581"><span class="mi" id="MathJax-Span-582" style="font-family: MathJax_Math; font-style: italic;">F<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.106em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.9em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>F</mi></math></span></span><script type="math/tex" id="MathJax-Element-70">F</script>, but extends to the depth of its input. e.g. A typical filter
might be <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-71-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-583" style="width: 4.552em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.927em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.442em, 1003.88em, 2.417em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-584"><span class="mn" id="MathJax-Span-585" style="font-family: MathJax_Main;">3</span><span class="mo" id="MathJax-Span-586" style="font-family: MathJax_Main; padding-left: 0.222em;">×</span><span class="mn" id="MathJax-Span-587" style="font-family: MathJax_Main; padding-left: 0.222em;">3</span><span class="mo" id="MathJax-Span-588" style="font-family: MathJax_Main; padding-left: 0.222em;">×</span><span class="mn" id="MathJax-Span-589" style="font-family: MathJax_Main; padding-left: 0.222em;">3</span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.081em; border-left: 0px solid; width: 0px; height: 0.908em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>3</mn><mo>×</mo><mn>3</mn><mo>×</mo><mn>3</mn></math></span></span><script type="math/tex" id="MathJax-Element-71">3 \times 3 \times 3</script> (<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-72-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;F&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-590" style="width: 3.02em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.586em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.523em, 1002.54em, 2.512em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-591"><span class="mi" id="MathJax-Span-592" style="font-family: MathJax_Math; font-style: italic;">F<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.106em;"></span></span><span class="mo" id="MathJax-Span-593" style="font-family: MathJax_Main; padding-left: 0.278em;">=</span><span class="mn" id="MathJax-Span-594" style="font-family: MathJax_Main; padding-left: 0.278em;">3</span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.081em; border-left: 0px solid; width: 0px; height: 0.925em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>F</mi><mo>=</mo><mn>3</mn></math></span></span><script type="math/tex" id="MathJax-Element-72">F = 3</script> pixels wide and high, and <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-73-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-595" style="width: 0.577em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.479em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.442em, 1000.44em, 2.417em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-596"><span class="mn" id="MathJax-Span-597" style="font-family: MathJax_Main;">3</span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.081em; border-left: 0px solid; width: 0px; height: 0.908em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>3</mn></math></span></span><script type="math/tex" id="MathJax-Element-73">3</script>
from the depth of the input 3-channel colour image).</p>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/conv-layer.gif" alt="A demo of a conv layer with K = 2 filters, each with a spatial extent F = 3 , moving at a stride S = 2, and input padding P = 1. (Reproduced from CS231n notes.)">
  <figcaption>A demo of a conv layer with K = 2 filters, each with a 
spatial extent F = 3 , moving at a stride S = 2, and input padding P = 
1. (Reproduced from CS231n notes.)</figcaption>
</figure>


<p>Now we slide or <em>convolve</em> this filter set over the input volume (with
a stride <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-74-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;S&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-598" style="width: 0.721em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.623em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.498em, 1000.62em, 2.512em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-599"><span class="mi" id="MathJax-Span-600" style="font-family: MathJax_Math; font-style: italic;">S<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.032em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.081em; border-left: 0px solid; width: 0px; height: 0.954em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>S</mi></math></span></span><script type="math/tex" id="MathJax-Element-74">S</script> that denotes how fast we move). This input can be
spatially padded (<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-75-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;P&lt;/mi&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-601" style="width: 0.912em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.766em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.52em, 1000.77em, 2.49em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-602"><span class="mi" id="MathJax-Span-603" style="font-family: MathJax_Math; font-style: italic;">P<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.109em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.903em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>P</mi></math></span></span><script type="math/tex" id="MathJax-Element-75">P</script>) with zeros as needed for controlling output
spatial dimensions. As we slide, each filter computes a sort of
volumetric dot product with the input to produce a 2D output, and when
we stack these across all the filters we have in our set, we get a 3D
output volume.</p>

<p>This is going to take you a bit of time to think about and process,
but the idea is quite simple when you get it.</p>

<p>The interesting things to note here are that:</p>

<ol>
<li><p>Because this filter set is the same as we vary spatial position,
once they’ve learnt to get excited about a feature, say a slanted line
in one position, they’ve learnt to get excited at any spatial
position. i.e. Translation of features around the input image doesn’t
matter.</p></li>

<li><p>We’re no longer ballooning in terms of number of parameters even if
the input image size grows a lot or our number of layers grow. All we
need to learn are the weights and biases that correspond to our sets
of filters (denoted in red in the animation above), which are
particularly small in number because of their small spatial size.</p></li>
</ol>

<h5 id="pooling-pool-layer">Pooling (Pool) layer</h5>

<p>The second important kind of layer in convnets is the <em>pooling (Pool)
layer</em>. This is much easier to understand, as it simply acts as a
downsampling filter. These are used to reduce computational cost, and
to some extent also reduce overfitting. Note that it has no
parameters to learn!</p>

<p>TODO: Depict a pool layer in a figure.</p>

<p>For example, a max pooling layer with a spatial extent <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-76-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;F&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-604" style="width: 3.02em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.586em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.523em, 1002.54em, 2.49em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-605"><span class="mi" id="MathJax-Span-606" style="font-family: MathJax_Math; font-style: italic;">F<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.106em;"></span></span><span class="mo" id="MathJax-Span-607" style="font-family: MathJax_Main; padding-left: 0.278em;">=</span><span class="mn" id="MathJax-Span-608" style="font-family: MathJax_Main; padding-left: 0.278em;">2</span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.9em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>F</mi><mo>=</mo><mn>2</mn></math></span></span><script type="math/tex" id="MathJax-Element-76">F = 2</script> and a
stride <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-77-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mi&gt;S&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-609" style="width: 2.924em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.49em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.498em, 1002.44em, 2.512em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-610"><span class="mi" id="MathJax-Span-611" style="font-family: MathJax_Math; font-style: italic;">S<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.032em;"></span></span><span class="mo" id="MathJax-Span-612" style="font-family: MathJax_Main; padding-left: 0.278em;">=</span><span class="mn" id="MathJax-Span-613" style="font-family: MathJax_Main; padding-left: 0.278em;">2</span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.081em; border-left: 0px solid; width: 0px; height: 0.954em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>S</mi><mo>=</mo><mn>2</mn></math></span></span><script type="math/tex" id="MathJax-Element-77">S = 2</script> halves the input spatial dimension from <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-78-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mn&gt;4&lt;/mn&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mn&gt;4&lt;/mn&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-614" style="width: 2.589em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.203em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.43em, 1002.17em, 2.395em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-615"><span class="mn" id="MathJax-Span-616" style="font-family: MathJax_Main;">4</span><span class="mo" id="MathJax-Span-617" style="font-family: MathJax_Main; padding-left: 0.222em;">×</span><span class="mn" id="MathJax-Span-618" style="font-family: MathJax_Main; padding-left: 0.222em;">4</span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.896em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>4</mn><mo>×</mo><mn>4</mn></math></span></span><script type="math/tex" id="MathJax-Element-78">4 \times 4</script> to
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-79-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-619" style="width: 2.589em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.203em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.441em, 1002.15em, 2.395em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-620"><span class="mn" id="MathJax-Span-621" style="font-family: MathJax_Main;">2</span><span class="mo" id="MathJax-Span-622" style="font-family: MathJax_Main; padding-left: 0.222em;">×</span><span class="mn" id="MathJax-Span-623" style="font-family: MathJax_Main; padding-left: 0.222em;">2</span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.884em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>2</mn><mo>×</mo><mn>2</mn></math></span></span><script type="math/tex" id="MathJax-Element-79">2 \times 2</script>, leaving the depth unchanged. It does this by picking the
maximum of each set of <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-80-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mn&gt;2&lt;/mn&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-624" style="width: 2.589em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.203em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.441em, 1002.15em, 2.395em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-625"><span class="mn" id="MathJax-Span-626" style="font-family: MathJax_Main;">2</span><span class="mo" id="MathJax-Span-627" style="font-family: MathJax_Main; padding-left: 0.222em;">×</span><span class="mn" id="MathJax-Span-628" style="font-family: MathJax_Main; padding-left: 0.222em;">2</span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.884em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>2</mn><mo>×</mo><mn>2</mn></math></span></span><script type="math/tex" id="MathJax-Element-80">2 \times 2</script> numbers and passing only those
along to the output. You have one such pooling layer for each input
depth slice to cover the entire input volume.</p>

<p>You can also do <em>average pooling</em> and other kinds of downsampling.</p>

<h4 id="notebook-4-a-convnet-based-mnist-digit-classifier-in-tensorflow">Notebook 4: A convnet-based MNIST digit classifier in TensorFlow</h4>

<p>Now that we’ve taken a theoretical look at the two kinds of layers
that are core to convnets (Conv and Pool), we’re going to get a better
feeling for them by using them in a practical example. Let’s return to
extend our MNIST digit classifier with these additional two layers and
see what kinds of gains we get in classification accuracy.</p>

<p>This example is a simplification of <a href="https://www.tensorflow.org/get_started/mnist/pros">Deep MNIST for Experts
tutorial</a> on the TensorFlow
website. And as before, the complete code for this example lives <a href="https://github.com/hnarayanan/artistic-style-transfer/blob/master/notebooks/4_Convolutional_Neural_Network-based_Image_Classifier.ipynb">in a
standalone notebook</a> in the accompanying repository. Here
I only step through the differences relative to our earlier
(fully-connected) neural network version.</p>

<p>Before we get to the code, let’s reintroduce some abstract notation to
better explain the changes we’re making.</p>

<pre><code class="hljs ini"><span class="hljs-setting">FC = <span class="hljs-value">Fully Connected Layer</span></span>
<span class="hljs-setting">Softmax = <span class="hljs-value">Softmax Layer</span></span>
<span class="hljs-setting">ReLU = <span class="hljs-value">Rectified Linear Unit Activation</span></span>
<span class="hljs-setting">Conv = <span class="hljs-value">Convolutional Layer</span></span>
<span class="hljs-setting">Pool = <span class="hljs-value">Pool Layer</span></span>
</code></pre>

<p>Using this notation, the models we’ve used for the score function so
far are:</p>

<ol>
<li><strong>Linear:</strong> <code>FC -&gt; Softmax</code></li>
<li><strong>Neural network (one hidden layer):</strong> <code>FC -&gt; ReLU -&gt; FC -&gt; Softmax</code></li>
</ol>

<p>And the convnet-based model we’re going to setup using the code below
is:</p>

<p><code>Conv -&gt; ReLU -&gt; Pool -&gt; FC -&gt; ReLU -&gt; FC -&gt; Softmax</code></p>

<pre><code class="language-python hljs"><span class="hljs-comment"># Define some helper functions to ease the definition of the model</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">weight_variable</span><span class="hljs-params">(shape)</span>:</span>
    <span class="hljs-keyword">return</span> tf.Variable(tf.truncated_normal(shape, stddev=<span class="hljs-number">0.1</span>))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bias_variable</span><span class="hljs-params">(shape)</span>:</span>
    <span class="hljs-keyword">return</span> tf.Variable(tf.constant(<span class="hljs-number">0.1</span>, shape=shape))

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">conv</span><span class="hljs-params">(x, W)</span>:</span>
    <span class="hljs-keyword">return</span> tf.nn.conv2d(x, W, strides=[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>], padding=<span class="hljs-string">'SAME'</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pool</span><span class="hljs-params">(x)</span>:</span>
    <span class="hljs-keyword">return</span> tf.nn.max_pool(x, ksize=[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>], strides=[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>], padding=<span class="hljs-string">'SAME'</span>)

<span class="hljs-comment"># A score function (model) composed of a few layers</span>

<span class="hljs-comment"># Reshape the input to look like a volume (Input)</span>
x_image = tf.reshape(x, [-<span class="hljs-number">1</span>, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">1</span>])

<span class="hljs-comment"># A convolutional layer (CONV -&gt; RELU -&gt; POOL)</span>
W_conv = weight_variable([<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">32</span>])
b_conv = bias_variable([<span class="hljs-number">32</span>])
h_conv = tf.nn.relu(conv(x_image, W_conv) + b_conv)
h_pool = pool(h_conv)

<span class="hljs-comment"># A densely connected layer (FC)</span>
W_fc1 = weight_variable([<span class="hljs-number">14</span>*<span class="hljs-number">14</span>*<span class="hljs-number">32</span>, <span class="hljs-number">1024</span>])
b_fc1 = bias_variable([<span class="hljs-number">1024</span>])
h_pool_flat = tf.reshape(h_pool, [-<span class="hljs-number">1</span>, <span class="hljs-number">14</span>*<span class="hljs-number">14</span>*<span class="hljs-number">32</span>])
h_fc1 = tf.nn.relu(tf.matmul(h_pool_flat, W_fc1) + b_fc1)

<span class="hljs-comment"># Another densely connected layer (for "readout") (FC)</span>
W_fc2 = weight_variable([<span class="hljs-number">1024</span>, <span class="hljs-number">10</span>])
b_fc2 = bias_variable([<span class="hljs-number">10</span>])
y = tf.nn.softmax(tf.matmul(h_fc1, W_fc2) + b_fc2)
</code></pre>

<p>As before, we then define the cross entropy loss function that
quantifies how poorly this model performs on images with known labels
and use an optimiser to iteratively improve parameters and minimise
the loss. And once this model is trained, we can pass it test images
and labels and determine the average accuracy.</p>

<pre><code class="language-python hljs">print(sess.run(accuracy, feed_dict={x: mnist.test.images, y_: mnist.test.labels}))
</code></pre>

<pre><code class="hljs cpp"><span class="hljs-number">0.989</span>
</code></pre>

<p>Nearly 99% accurate! Great!</p>

<h4 id="how-do-convnets-work-so-well">How do convnets work (so well)?</h4>

<p>If you found yourself working through <a href="https://github.com/hnarayanan/artistic-style-transfer/blob/master/notebooks/4_Convolutional_Neural_Network-based_Image_Classifier.ipynb">Notebook 4</a> being
fuzzy about how our convnet-based classifier actually works, here is a
<a href="https://transcranial.github.io/keras-js/#/mnist-cnn">wonderful webpage</a> that provides more insight.</p>

<figure>
  <a href="https://transcranial.github.io/keras-js/#/mnist-cnn"><img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/mnist-web-demo.png" alt="Better understanding what a convnet-based classifier does with the MNIST data"></a>
  <figcaption>Better understanding what a convnet-based classifier does with the MNIST data.</figcaption>
</figure>

<p>You play around with it by drawing any digit you want. As you do, the
webpage helps visualise the outputs of the different layers, leading
to the (softmax) classification in the end. You get a sense that as
you go from layer to layer, the system essentially transforms
representations of the input into forms that are more suitable to the
task at hand — classification in our case.</p>

<p>To reiterate this, let’s look at another visualisation of a convnet
classifier.</p>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/representation-learning.png" alt="Convnets (and deep learning in general) are all about learning representations. (Reproduced from the Deep Learning Book.)">
  <figcaption>Convnets (and deep learning in general) are all about learning representations. (Reproduced from the Deep Learning Book.)</figcaption>
</figure>


<p>Given raw pixel input, the first hidden layer get excited by simple
features like edges, the next layer perhaps things like contours, and
the next maybe simple shapes and part of objects. And the deeper you
go, the more they start to grasp the entire input field, not just a
narrow region, but more importantly, the closer they’re moving toward
a <em>representation that makes it easy for them to classify on</em>.</p>

<p>It turns out that convolutional neural networks are all about
<em>representation learning</em>. This is what makes them so powerful.</p>

<p>In fact, this is true of <em>deep learning</em> in
general (we call these models <em>deep</em> as we start to stack on more
layers). It’s just that convnets are disproportionately used as
teaching examples (as I’m doing right now) because each layer does
something at least <a href="http://yosinski.com/deepvis">vaguely recognisable to
humans</a>.</p>

<p>TODO: Polish this section and connect back to the idea that we turned
to machine learning in the first place because we found it so
difficult to write a program that hand-engineered features for image
classification.</p>

<h2 id="returning-to-the-style-transfer-problem">Returning to the style transfer problem</h2>

<p>Now that we have the vocabulary to talk about convnets and have some
insight into how they behave, we’re <em>finally</em> in a good place to
return to the original style transfer problem that motivated this
entire journey.</p>

<p><a href="#so-what-is-prisma-and-how-might-it-work">Recall</a> that we had a content image
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-81-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;c&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-629" style="width: 0.625em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.527em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.606em, 1000.49em, 2.353em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-630"><span class="texatom" id="MathJax-Span-631"><span class="mrow" id="MathJax-Span-632"><span class="mi" id="MathJax-Span-633" style="font-family: MathJax_Main; font-weight: bold;">c</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.063em; border-left: 0px solid; width: 0px; height: 0.644em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">c</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-81">\mathbf{c}</script> and a style image <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-82-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;s&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-634" style="width: 0.529em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.431em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.606em, 1000.39em, 2.353em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-635"><span class="texatom" id="MathJax-Span-636"><span class="mrow" id="MathJax-Span-637"><span class="mi" id="MathJax-Span-638" style="font-family: MathJax_Main; font-weight: bold;">s</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.063em; border-left: 0px solid; width: 0px; height: 0.644em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">s</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-82">\mathbf{s}</script>, and the core of this
effect was to somehow extract the style (the colour and textures) from
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-83-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;s&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-639" style="width: 0.529em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.431em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.606em, 1000.39em, 2.353em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-640"><span class="texatom" id="MathJax-Span-641"><span class="mrow" id="MathJax-Span-642"><span class="mi" id="MathJax-Span-643" style="font-family: MathJax_Main; font-weight: bold;">s</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.063em; border-left: 0px solid; width: 0px; height: 0.644em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">s</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-83">\mathbf{s}</script> and apply it to the content (the structure) from
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-84-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;c&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-644" style="width: 0.625em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.527em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.606em, 1000.49em, 2.353em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-645"><span class="texatom" id="MathJax-Span-646"><span class="mrow" id="MathJax-Span-647"><span class="mi" id="MathJax-Span-648" style="font-family: MathJax_Main; font-weight: bold;">c</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.063em; border-left: 0px solid; width: 0px; height: 0.644em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">c</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-84">\mathbf{c}</script> to arrive at the sort of example output shown below.</p>

<figure>
<div class="pure-g">
  <div class="pure-u-1-3">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/edtaonisl.jpg" alt="The style image, Edtaonisl by Francis Picabia">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/hugo-sleeping.jpg" alt="The content image, my toddler sleeping">
  </div>
  <div class="pure-u-2-3">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/style-transferred.jpg" alt="The style-transferred image generated by Prisma">
  </div>
</div>
<figcaption>A three part image, showing the style image, <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-85-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;s&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-649" style="width: 0.578em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.471em; height: 0px; font-size: 118%;"><span style="position: absolute; clip: rect(1.587em, 1000.43em, 2.36em, -1000em); top: -2.197em; left: 0em;"><span class="mrow" id="MathJax-Span-650"><span class="texatom" id="MathJax-Span-651"><span class="mrow" id="MathJax-Span-652"><span class="mi" id="MathJax-Span-653" style="font-family: MathJax_Main; font-weight: bold;">s</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.197em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.069em; border-left: 0px solid; width: 0px; height: 0.665em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">s</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-85">\mathbf{s}</script>, the content image, <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-86-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;c&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-654" style="width: 0.63em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.523em; height: 0px; font-size: 118%;"><span style="position: absolute; clip: rect(1.587em, 1000.49em, 2.36em, -1000em); top: -2.197em; left: 0em;"><span class="mrow" id="MathJax-Span-655"><span class="texatom" id="MathJax-Span-656"><span class="mrow" id="MathJax-Span-657"><span class="mi" id="MathJax-Span-658" style="font-family: MathJax_Main; font-weight: bold;">c</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.197em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.069em; border-left: 0px solid; width: 0px; height: 0.665em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">c</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-86">\mathbf{c}</script>, and the style-transferred image, <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-87-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-659" style="width: 0.735em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.628em; height: 0px; font-size: 118%;"><span style="position: absolute; clip: rect(1.596em, 1000.61em, 2.354em, -1000em); top: -2.197em; left: 0em;"><span class="mrow" id="MathJax-Span-660"><span class="texatom" id="MathJax-Span-661"><span class="mrow" id="MathJax-Span-662"><span class="mi" id="MathJax-Span-663" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.197em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.062em; border-left: 0px solid; width: 0px; height: 0.647em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-87">\mathbf{x}</script>.</figcaption>
</figure>

<p>Recall also that after looking at the <a href="https://arxiv.org/abs/1508.06576">original paper from Gatys et
al.</a>, we were able to pose this as an
optimisation problem:</p>

<p><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_Display" style="text-align: center;"><span class="MathJax" id="MathJax-Element-88-Frame" tabindex="0" style="text-align: center; position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;msup&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;&amp;#x2217;&lt;/mo&gt;&lt;/msup&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;munder&gt;&lt;mi&gt;argmin&lt;/mi&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;/munder&gt;&lt;mrow&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mrow&gt;&lt;mi&gt;&amp;#x03B1;&lt;/mi&gt;&lt;msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;&gt;L&lt;/mi&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;c&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;o&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;n&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;t&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;e&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;n&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;t&lt;/mi&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;c&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mi&gt;&amp;#x03B2;&lt;/mi&gt;&lt;msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;&gt;L&lt;/mi&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;s&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;t&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;y&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;l&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;e&lt;/mi&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;s&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-664" style="width: 21.746em; display: inline-block;"><span style="display: inline-block; position: relative; width: 18.726em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.453em, 1018.63em, 3.396em, -1000em); top: -2.347em; left: 0em;"><span class="mrow" id="MathJax-Span-665"><span class="msubsup" id="MathJax-Span-666"><span style="display: inline-block; position: relative; width: 1.036em; height: 0px;"><span style="position: absolute; clip: rect(3.435em, 1000.59em, 4.167em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-667"><span class="mrow" id="MathJax-Span-668"><span class="mi" id="MathJax-Span-669" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -4.436em; left: 0.607em;"><span class="mo" id="MathJax-Span-670" style="font-size: 70.7%; font-family: MathJax_Main;">∗</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-671" style="font-family: MathJax_Main; padding-left: 0.278em;">=</span><span class="munder" id="MathJax-Span-672" style="padding-left: 0.278em;"><span style="display: inline-block; position: relative; width: 3.059em; height: 0px;"><span style="position: absolute; clip: rect(3.21em, 1003.05em, 4.373em, -1000em); top: -4.023em; left: 0em;"><span class="mi" id="MathJax-Span-673" style="font-family: MathJax_Main;">argmin</span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; clip: rect(3.565em, 1000.41em, 4.267em, -1000em); top: -3.217em; left: 1.315em;"><span class="texatom" id="MathJax-Span-674"><span class="mrow" id="MathJax-Span-675"><span class="mi" id="MathJax-Span-676" style="font-size: 70.7%; font-family: MathJax_Main; font-weight: bold;">x</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mrow" id="MathJax-Span-677" style="padding-left: 0.167em;"><span class="mo" id="MathJax-Span-678" style=""><span style="font-family: MathJax_Main;">(</span></span><span class="mrow" id="MathJax-Span-679"><span class="mi" id="MathJax-Span-680" style="font-family: MathJax_Math; font-style: italic;">α</span><span class="msubsup" id="MathJax-Span-681"><span style="display: inline-block; position: relative; width: 3.083em; height: 0px;"><span style="position: absolute; clip: rect(3.174em, 1000.66em, 4.189em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-682"><span class="mrow" id="MathJax-Span-683"><span class="mi" id="MathJax-Span-684" style="font-family: MathJax_Caligraphic;">L</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.69em;"><span class="texatom" id="MathJax-Span-685"><span class="mrow" id="MathJax-Span-686"><span class="texatom" id="MathJax-Span-687"><span class="mrow" id="MathJax-Span-688"><span class="mi" id="MathJax-Span-689" style="font-size: 70.7%; font-family: MathJax_Main;">c</span><span class="mi" id="MathJax-Span-690" style="font-size: 70.7%; font-family: MathJax_Main;">o</span><span class="mi" id="MathJax-Span-691" style="font-size: 70.7%; font-family: MathJax_Main;">n</span><span class="mi" id="MathJax-Span-692" style="font-size: 70.7%; font-family: MathJax_Main;">t</span><span class="mi" id="MathJax-Span-693" style="font-size: 70.7%; font-family: MathJax_Main;">e</span><span class="mi" id="MathJax-Span-694" style="font-size: 70.7%; font-family: MathJax_Main;">n</span><span class="mi" id="MathJax-Span-695" style="font-size: 70.7%; font-family: MathJax_Main;">t</span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-696" style="font-family: MathJax_Main;">(</span><span class="texatom" id="MathJax-Span-697"><span class="mrow" id="MathJax-Span-698"><span class="mi" id="MathJax-Span-699" style="font-family: MathJax_Main; font-weight: bold;">c</span></span></span><span class="mo" id="MathJax-Span-700" style="font-family: MathJax_Main;">,</span><span class="texatom" id="MathJax-Span-701" style="padding-left: 0.167em;"><span class="mrow" id="MathJax-Span-702"><span class="mi" id="MathJax-Span-703" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span><span class="mo" id="MathJax-Span-704" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-705" style="font-family: MathJax_Main; padding-left: 0.222em;">+</span><span class="mi" id="MathJax-Span-706" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.222em;">β<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.007em;"></span></span><span class="msubsup" id="MathJax-Span-707"><span style="display: inline-block; position: relative; width: 2.203em; height: 0px;"><span style="position: absolute; clip: rect(3.174em, 1000.66em, 4.189em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-708"><span class="mrow" id="MathJax-Span-709"><span class="mi" id="MathJax-Span-710" style="font-family: MathJax_Caligraphic;">L</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.69em;"><span class="texatom" id="MathJax-Span-711"><span class="mrow" id="MathJax-Span-712"><span class="texatom" id="MathJax-Span-713"><span class="mrow" id="MathJax-Span-714"><span class="mi" id="MathJax-Span-715" style="font-size: 70.7%; font-family: MathJax_Main;">s</span><span class="mi" id="MathJax-Span-716" style="font-size: 70.7%; font-family: MathJax_Main;">t</span><span class="mi" id="MathJax-Span-717" style="font-size: 70.7%; font-family: MathJax_Main;">y</span><span class="mi" id="MathJax-Span-718" style="font-size: 70.7%; font-family: MathJax_Main;">l</span><span class="mi" id="MathJax-Span-719" style="font-size: 70.7%; font-family: MathJax_Main;">e</span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-720" style="font-family: MathJax_Main;">(</span><span class="texatom" id="MathJax-Span-721"><span class="mrow" id="MathJax-Span-722"><span class="mi" id="MathJax-Span-723" style="font-family: MathJax_Main; font-weight: bold;">s</span></span></span><span class="mo" id="MathJax-Span-724" style="font-family: MathJax_Main;">,</span><span class="texatom" id="MathJax-Span-725" style="padding-left: 0.167em;"><span class="mrow" id="MathJax-Span-726"><span class="mi" id="MathJax-Span-727" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span><span class="mo" id="MathJax-Span-728" style="font-family: MathJax_Main;">)</span></span><span class="mo" id="MathJax-Span-729" style=""><span style="font-family: MathJax_Main;">)</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.347em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -1.107em; border-left: 0px solid; width: 0px; height: 2.032em;"></span></span></nobr><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msup><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow><mo>∗</mo></msup><mo>=</mo><munder><mi>argmin</mi><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow></munder><mrow><mo>(</mo><mrow><mi>α</mi><msub><mrow class="MJX-TeXAtom-ORD"><mi class="MJX-tex-caligraphic" mathvariant="script">L</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi></mrow></mrow></msub><mo stretchy="false">(</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">c</mi></mrow><mo>,</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow><mo stretchy="false">)</mo><mo>+</mo><mi>β</mi><msub><mrow class="MJX-TeXAtom-ORD"><mi class="MJX-tex-caligraphic" mathvariant="script">L</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="normal">s</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">e</mi></mrow></mrow></msub><mo stretchy="false">(</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">s</mi></mrow><mo>,</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow><mo stretchy="false">)</mo></mrow><mo>)</mo></mrow></math></span></span></div><script type="math/tex; mode=display" id="MathJax-Element-88">
\mathbf{x}^* = \underset{\mathbf{x}}{\operatorname{argmin}}\left(\alpha
\mathcal{L}_{\mathrm{content}}(\mathbf{c}, \mathbf{x}) + \beta
\mathcal{L}_{\mathrm{style}}(\mathbf{s}, \mathbf{x})\right)
</script></p>

<p>That is, we are looking for an image <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-89-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-730" style="width: 0.721em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.623em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.615em, 1000.6em, 2.347em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-731"><span class="texatom" id="MathJax-Span-732"><span class="mrow" id="MathJax-Span-733"><span class="mi" id="MathJax-Span-734" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.056em; border-left: 0px solid; width: 0px; height: 0.626em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-89">\mathbf{x}</script> that differs as
little as possible <em>in terms of content</em> from the content image
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-90-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;c&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-735" style="width: 0.625em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.527em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.606em, 1000.49em, 2.353em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-736"><span class="texatom" id="MathJax-Span-737"><span class="mrow" id="MathJax-Span-738"><span class="mi" id="MathJax-Span-739" style="font-family: MathJax_Main; font-weight: bold;">c</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.063em; border-left: 0px solid; width: 0px; height: 0.644em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">c</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-90">\mathbf{c}</script>, while simultaneously differing as little as possible <em>in
terms of style</em> from the style image <span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-91-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;s&lt;/mi&gt;&lt;/mrow&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-740" style="width: 0.529em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.431em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.606em, 1000.39em, 2.353em, -1000em); top: -2.203em; left: 0em;"><span class="mrow" id="MathJax-Span-741"><span class="texatom" id="MathJax-Span-742"><span class="mrow" id="MathJax-Span-743"><span class="mi" id="MathJax-Span-744" style="font-family: MathJax_Main; font-weight: bold;">s</span></span></span></span><span style="display: inline-block; width: 0px; height: 2.203em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.063em; border-left: 0px solid; width: 0px; height: 0.644em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">s</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-91">\mathbf{s}</script>. The only hitch in
this plan was that we didn’t have a convenient way to gauge the
differences between images in terms of content and style.</p>

<p>But now we do!</p>

<p>It turns out that convnets pre-trained for image classification <em>have
already learnt to encode perceptual and semantic information that we
need to measure these semantic difference terms</em>! The primary
explanation for this is that when learning object recognition, the
<em>network has to become invariant to all image variation that’s
superfluous to object identity</em>.</p>

<p>So in what follows, we’re first going to get acquainted with a
particular deep convnet-based image classifier called
<a href="https://arxiv.org/abs/1409.1556">VGGNet</a>, and soon see how it can be
repurposed for the style transfer problem.</p>

<h3 id="the-convnet-based-classifier-at-the-heart-of-the-gatys-paper">The convnet-based classifier at the heart of the Gatys paper</h3>

<p>When we completed <a href="https://github.com/hnarayanan/artistic-style-transfer/blob/master/notebooks/4_Convolutional_Neural_Network-based_Image_Classifier.ipynb">Notebook 4</a>, we’d worked out a simple
convnet-based image classifier that did a great job at classifying the
MNIST dataset. Now we’re going to see a family of more powerful
architectures called <a href="https://arxiv.org/abs/1409.1556">VGGNet</a> that can work
with more general data: <a href="http://image-net.org/">colour images of different
objects</a>. This network is at the core of the <a href="https://arxiv.org/abs/1508.06576">Gatys style
transfer paper</a> as we’ll soon see.</p>

<p>Recall that when we last implemented even our simple convnet, it was
hard to write (in terms of boilerplate code, and keeping careful track
of the shapes of the objects flowing through the code) and slow to
train. To circumvent that, we aren’t going to write VGGNet from
scratch. We’re going to instead use a version that someone else has
already written and pre-trained.</p>

<p>To simplify our lives even further, we’re no longer going to use
TensorFlow proper from this point on — we’re going to move to a
higher-level library called <a href="https://keras.io/">Keras</a>. About a month ago it was
<a href="https://www.youtube.com/watch?v=UeheTiBJ0Io">announced that Keras is going to be folded into the official
TensorFlow project</a> — meaning that the simpler
API you’re going to see could soon be TensorFlow’s API! This is great
because TensorFlow often operates at a lower level than you care about
when you want to simply quickly experiment with deep learning.</p>

<p>I’ve incorporated <a href="https://github.com/hnarayanan/artistic-style-transfer/blob/master/notebooks/5_VGG_Net_16_the_easy_way.ipynb">Notebook 5</a> in its entirety below since
it is very different from the notebooks we’ve seen thus far.</p>

<h4 id="notebook-5-fetching-and-playing-with-a-pre-trained-vggnet-16-in-keras">Notebook 5: Fetching and playing with a pre-trained VGGNet (16) in Keras</h4>

<p>Let’s start by importing some packages we need. Note that even though
we’ve moved to Keras, it uses TensorFlow in the background for
low-level operations like tensor products and convolutions.</p>

<pre><code class="language-python hljs"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image

<span class="hljs-keyword">from</span> keras.applications.vgg16 <span class="hljs-keyword">import</span> VGG16
<span class="hljs-keyword">from</span> keras.applications.vgg16 <span class="hljs-keyword">import</span> preprocess_input, decode_predictions
</code></pre>

<pre><code class="hljs nginx"><span class="hljs-title">Using</span> TensorFlow backend.
</code></pre>

<h5 id="getting-a-feel-for-the-model-and-data-it-is-trained-on">Getting a feel for the model and data it is trained on</h5>

<p>In this notebook, we’re going to fetch a network that is pre-trained
on the <a href="http://image-net.org/">ImageNet</a> data set. In particular, we’re going to
fetch the <a href="https://arxiv.org/abs/1409.1556">VGGNet</a> model with 16 layers
(that we’re going to refer to as <code>VGG16</code>).</p>

<p>The ImageNet project is a large visual database designed for use in
visual object recognition software research. As of 2016, <a href="https://en.wikipedia.org/wiki/ImageNet">over ten
million URLs of images</a> have been hand-annotated by
ImageNet to indicate what objects are pictured. ImageNet crowdsources
its annotation process.</p>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/imagenet-sample.jpg" alt="A sample of the ImageNet dataset.">
  <figcaption>A sample of the ImageNet dataset.</figcaption>
</figure>


<p>Since 2010, the annual ImageNet Large Scale Visual Recognition
Challenge (ILSVRC) is a competition where research teams submit
programs that classify and detect objects and scenes. (This is like
the Olympics of computer vision challenges!)</p>

<p>VGGNet was introduced as one of the contenders in 2014’s ImageNet
Challenge and <a href="http://image-net.org/challenges/LSVRC/2014/results">secured the first and the second
places</a> in the localisation and classification
tracks respectively. It was later described in great detail in <a href="https://arxiv.org/abs/1409.1556">a
paper that came out the following year</a>. The
paper describes how a family of models essentially composed of simple
(<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-92-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;mo&gt;&amp;#x00D7;&lt;/mo&gt;&lt;mn&gt;3&lt;/mn&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-745" style="width: 2.589em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.203em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.442em, 1002.16em, 2.417em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-746"><span class="mn" id="MathJax-Span-747" style="font-family: MathJax_Main;">3</span><span class="mo" id="MathJax-Span-748" style="font-family: MathJax_Main; padding-left: 0.222em;">×</span><span class="mn" id="MathJax-Span-749" style="font-family: MathJax_Main; padding-left: 0.222em;">3</span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.081em; border-left: 0px solid; width: 0px; height: 0.908em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>3</mn><mo>×</mo><mn>3</mn></math></span></span><script type="math/tex" id="MathJax-Element-92">3 \times 3</script>) convolutional filters with increasing depth (11–19
layers) managed to perform so well at a range of computer vision
tasks.</p>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/vgg-16-architecture.png" alt="VGGNet Architectures highlighting the 16-layer variant.">
  <figcaption>VGGNet Architectures highlighting the 16-layer variant.</figcaption>
</figure>


<p>We’re going to first reproduce the 16 layer variant marked in green
for classification, and in the next notebook we’ll see how it can be
repurposed for the style transfer problem.</p>

<h5 id="fetching-a-pretrained-model-in-keras">Fetching a pretrained model in Keras</h5>

<p>This is trivial to do in Keras, and can be done in a single
line. <a href="https://github.com/fchollet/keras/tree/master/keras/applications">There is a selection</a> of such models one
can import.</p>

<pre><code class="language-python hljs">model = VGG16(weights=<span class="hljs-string">'imagenet'</span>, include_top=<span class="hljs-keyword">True</span>)
</code></pre>

<p>Let’s take a look at the model, convince ourselves it looks the same
as the paper.</p>

<pre><code class="language-python hljs">layers = dict([(layer.name, layer.output) <span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> model.layers])
layers
</code></pre>

<pre><code class="hljs bash">{<span class="hljs-string">'block1_conv1'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu:0'</span> shape=(?, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>, <span class="hljs-number">64</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block1_conv2'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_1:0'</span> shape=(?, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>, <span class="hljs-number">64</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block1_pool'</span>: &lt;tf.Tensor <span class="hljs-string">'MaxPool:0'</span> shape=(?, <span class="hljs-number">112</span>, <span class="hljs-number">112</span>, <span class="hljs-number">64</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block2_conv1'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_2:0'</span> shape=(?, <span class="hljs-number">112</span>, <span class="hljs-number">112</span>, <span class="hljs-number">128</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block2_conv2'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_3:0'</span> shape=(?, <span class="hljs-number">112</span>, <span class="hljs-number">112</span>, <span class="hljs-number">128</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block2_pool'</span>: &lt;tf.Tensor <span class="hljs-string">'MaxPool_1:0'</span> shape=(?, <span class="hljs-number">56</span>, <span class="hljs-number">56</span>, <span class="hljs-number">128</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block3_conv1'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_4:0'</span> shape=(?, <span class="hljs-number">56</span>, <span class="hljs-number">56</span>, <span class="hljs-number">256</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block3_conv2'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_5:0'</span> shape=(?, <span class="hljs-number">56</span>, <span class="hljs-number">56</span>, <span class="hljs-number">256</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block3_conv3'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_6:0'</span> shape=(?, <span class="hljs-number">56</span>, <span class="hljs-number">56</span>, <span class="hljs-number">256</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block3_pool'</span>: &lt;tf.Tensor <span class="hljs-string">'MaxPool_2:0'</span> shape=(?, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">256</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block4_conv1'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_7:0'</span> shape=(?, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">512</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block4_conv2'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_8:0'</span> shape=(?, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">512</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block4_conv3'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_9:0'</span> shape=(?, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">512</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block4_pool'</span>: &lt;tf.Tensor <span class="hljs-string">'MaxPool_3:0'</span> shape=(?, <span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">512</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block5_conv1'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_10:0'</span> shape=(?, <span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">512</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block5_conv2'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_11:0'</span> shape=(?, <span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">512</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block5_conv3'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_12:0'</span> shape=(?, <span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">512</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block5_pool'</span>: &lt;tf.Tensor <span class="hljs-string">'MaxPool_4:0'</span> shape=(?, <span class="hljs-number">7</span>, <span class="hljs-number">7</span>, <span class="hljs-number">512</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'fc1'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_13:0'</span> shape=(?, <span class="hljs-number">4096</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'fc2'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_14:0'</span> shape=(?, <span class="hljs-number">4096</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'flatten'</span>: &lt;tf.Tensor <span class="hljs-string">'Reshape_13:0'</span> shape=(?, ?) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'input_1'</span>: &lt;tf.Tensor <span class="hljs-string">'input_1:0'</span> shape=(?, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>, <span class="hljs-number">3</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'predictions'</span>: &lt;tf.Tensor <span class="hljs-string">'Softmax:0'</span> shape=(?, <span class="hljs-number">1000</span>) dtype=<span class="hljs-built_in">float</span>32&gt;}
</code></pre>

<p>Looks good. And we now let’s get a sense for how many parameters they
are in this model.</p>

<pre><code class="language-python hljs">model.count_params()
</code></pre>

<pre><code class="hljs cpp"><span class="hljs-number">138357544</span>
</code></pre>

<p>Woah, that’s a lot! We’ve just gotten around needing to train a model
containing 138+ million parameters.</p>

<h5 id="using-it-for-classification">Using it for classification</h5>

<p>Now that we have our pre-trained model loaded, we can use it for classification.</p>

<h6 id="load-an-test-image-and-preprocess-it">Load an test image and preprocess it</h6>

<pre><code class="language-python hljs">image_path = <span class="hljs-string">'images/elephant.jpg'</span>
image = Image.open(image_path)
image = image.resize((<span class="hljs-number">224</span>, <span class="hljs-number">224</span>))
image
</code></pre>

<p><img src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/output_13_0.png" alt="png"></p>

<pre><code class="language-python hljs"><span class="hljs-comment"># Convert it into an array</span>
x = np.asarray(image, dtype=<span class="hljs-string">'float32'</span>)
<span class="hljs-comment"># Convert it into a list of arrays</span>
x = np.expand_dims(x, axis=<span class="hljs-number">0</span>)
<span class="hljs-comment"># Pre-process the input to match the training data</span>
x = preprocess_input(x)
</code></pre>

<h6 id="classify-the-test-image">Classify the test image</h6>

<p>The following code classifies the test image and decodes the results
into a list of tuples (class, description, probability). There is one
such list for each sample in the batch, but since we’re only sending
in one test image we only get one set of output.</p>

<pre><code class="language-python hljs">preds = model.predict(x)
print(<span class="hljs-string">'Predicted:'</span>, decode_predictions(preds, top=<span class="hljs-number">3</span>)[<span class="hljs-number">0</span>])
</code></pre>

<pre><code class="hljs python">(<span class="hljs-string">'Predicted:'</span>, [(<span class="hljs-string">u'n02504458'</span>, <span class="hljs-string">u'African_elephant'</span>, <span class="hljs-number">0.84805286</span>), (<span class="hljs-string">u'n01871265'</span>, <span class="hljs-string">u'tusker'</span>, <span class="hljs-number">0.10270286</span>), (<span class="hljs-string">u'n02504013'</span>, <span class="hljs-string">u'Indian_elephant'</span>, <span class="hljs-number">0.049056333</span>)])
</code></pre>

<h3 id="the-artistic-style-transfer-algorithm">The artistic style transfer algorithm</h3>

<p>In the process of learning how to classify images, the <code>VGG16</code> model
that we just downloaded and played with (in <a href="https://github.com/hnarayanan/artistic-style-transfer/blob/master/notebooks/5_VGG_Net_16_the_easy_way.ipynb">Notebook 5</a>)
has actually learnt a lot more. As it has trained itself to transform
the raw input pixels into category scores, it has learnt to encode
quite a bit of perceptual and semantic information about images. The
neural style algorithm introduced in <a href="https://arxiv.org/abs/1508.06576">Gatys et
al. (2015)</a> plays with these
representations to first define the semantic loss terms
(<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-93-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;&gt;L&lt;/mi&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;c&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;o&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;n&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;t&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;e&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;n&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;t&lt;/mi&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;c&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-750" style="width: 6.276em; display: inline-block;"><span style="display: inline-block; position: relative; width: 5.412em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.357em, 1005.32em, 2.645em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-751"><span class="msubsup" id="MathJax-Span-752"><span style="display: inline-block; position: relative; width: 3.083em; height: 0px;"><span style="position: absolute; clip: rect(3.174em, 1000.66em, 4.189em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-753"><span class="mrow" id="MathJax-Span-754"><span class="mi" id="MathJax-Span-755" style="font-family: MathJax_Caligraphic;">L</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.69em;"><span class="texatom" id="MathJax-Span-756"><span class="mrow" id="MathJax-Span-757"><span class="texatom" id="MathJax-Span-758"><span class="mrow" id="MathJax-Span-759"><span class="mi" id="MathJax-Span-760" style="font-size: 70.7%; font-family: MathJax_Main;">c</span><span class="mi" id="MathJax-Span-761" style="font-size: 70.7%; font-family: MathJax_Main;">o</span><span class="mi" id="MathJax-Span-762" style="font-size: 70.7%; font-family: MathJax_Main;">n</span><span class="mi" id="MathJax-Span-763" style="font-size: 70.7%; font-family: MathJax_Main;">t</span><span class="mi" id="MathJax-Span-764" style="font-size: 70.7%; font-family: MathJax_Main;">e</span><span class="mi" id="MathJax-Span-765" style="font-size: 70.7%; font-family: MathJax_Main;">n</span><span class="mi" id="MathJax-Span-766" style="font-size: 70.7%; font-family: MathJax_Main;">t</span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-767" style="font-family: MathJax_Main;">(</span><span class="texatom" id="MathJax-Span-768"><span class="mrow" id="MathJax-Span-769"><span class="mi" id="MathJax-Span-770" style="font-family: MathJax_Main; font-weight: bold;">c</span></span></span><span class="mo" id="MathJax-Span-771" style="font-family: MathJax_Main;">,</span><span class="texatom" id="MathJax-Span-772" style="padding-left: 0.167em;"><span class="mrow" id="MathJax-Span-773"><span class="mi" id="MathJax-Span-774" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span><span class="mo" id="MathJax-Span-775" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.346em; border-left: 0px solid; width: 0px; height: 1.271em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mrow class="MJX-TeXAtom-ORD"><mi class="MJX-tex-caligraphic" mathvariant="script">L</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi></mrow></mrow></msub><mo stretchy="false">(</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">c</mi></mrow><mo>,</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-93">\mathcal{L}_{\mathrm{content}}(\mathbf{c}, \mathbf{x})</script> and
<span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax" id="MathJax-Element-94-Frame" tabindex="0" style="position: relative;" data-mathml="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;msub&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi class=&quot;MJX-tex-caligraphic&quot; mathvariant=&quot;script&quot;&gt;L&lt;/mi&gt;&lt;/mrow&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;s&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;t&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;y&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;l&lt;/mi&gt;&lt;mi mathvariant=&quot;normal&quot;&gt;e&lt;/mi&gt;&lt;/mrow&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;mo stretchy=&quot;false&quot;&gt;(&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;s&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;,&lt;/mo&gt;&lt;mrow class=&quot;MJX-TeXAtom-ORD&quot;&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;x&lt;/mi&gt;&lt;/mrow&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;/mo&gt;&lt;/math&gt;" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-776" style="width: 5.223em; display: inline-block;"><span style="display: inline-block; position: relative; width: 4.502em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.357em, 1004.41em, 2.689em, -1000em); top: -2.251em; left: 0em;"><span class="mrow" id="MathJax-Span-777"><span class="msubsup" id="MathJax-Span-778"><span style="display: inline-block; position: relative; width: 2.203em; height: 0px;"><span style="position: absolute; clip: rect(3.174em, 1000.66em, 4.189em, -1000em); top: -4.023em; left: 0em;"><span class="texatom" id="MathJax-Span-779"><span class="mrow" id="MathJax-Span-780"><span class="mi" id="MathJax-Span-781" style="font-family: MathJax_Caligraphic;">L</span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span><span style="position: absolute; top: -3.873em; left: 0.69em;"><span class="texatom" id="MathJax-Span-782"><span class="mrow" id="MathJax-Span-783"><span class="texatom" id="MathJax-Span-784"><span class="mrow" id="MathJax-Span-785"><span class="mi" id="MathJax-Span-786" style="font-size: 70.7%; font-family: MathJax_Main;">s</span><span class="mi" id="MathJax-Span-787" style="font-size: 70.7%; font-family: MathJax_Main;">t</span><span class="mi" id="MathJax-Span-788" style="font-size: 70.7%; font-family: MathJax_Main;">y</span><span class="mi" id="MathJax-Span-789" style="font-size: 70.7%; font-family: MathJax_Main;">l</span><span class="mi" id="MathJax-Span-790" style="font-size: 70.7%; font-family: MathJax_Main;">e</span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.023em;"></span></span></span></span><span class="mo" id="MathJax-Span-791" style="font-family: MathJax_Main;">(</span><span class="texatom" id="MathJax-Span-792"><span class="mrow" id="MathJax-Span-793"><span class="mi" id="MathJax-Span-794" style="font-family: MathJax_Main; font-weight: bold;">s</span></span></span><span class="mo" id="MathJax-Span-795" style="font-family: MathJax_Main;">,</span><span class="texatom" id="MathJax-Span-796" style="padding-left: 0.167em;"><span class="mrow" id="MathJax-Span-797"><span class="mi" id="MathJax-Span-798" style="font-family: MathJax_Main; font-weight: bold;">x</span></span></span><span class="mo" id="MathJax-Span-799" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.251em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.397em; border-left: 0px solid; width: 0px; height: 1.322em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mrow class="MJX-TeXAtom-ORD"><mi class="MJX-tex-caligraphic" mathvariant="script">L</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="normal">s</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">e</mi></mrow></mrow></msub><mo stretchy="false">(</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">s</mi></mrow><mo>,</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="bold">x</mi></mrow><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-94">\mathcal{L}_{\mathrm{style}}(\mathbf{s}, \mathbf{x})</script>) and then uses
these terms to pose the optimisation problem for style transfer.</p>

<p>TODO: Fill out this section with the following notes, incorporating
whatever theory that is not covered inline in the final notebook. This
corresponds to slides 37–39 of the talk.</p>

<ul>
<li>Summarise the Gatys, et al. paper for the core ideas (and a
sketch of the solution methodology):

<ul>
<li>Higher layers in the network capture the high-level content in
terms of objects and their arrangement in the input image but do not
constrain the exact pixel values of the reconstruction. To obtain a
representation of the style of an input image, we employ
correlations between the different filter responses over the spatial
extent of the feature maps.</li>
<li>The representations of style and content in CNNs are separable.</li>
<li>The images are synthesised by finding an image that simultaneously
matches the content representation of the photograph and the style
representation of the respective piece of art.</li>
<li>Based on VGG16 - 3 FC layers. Normal VGG takes an image and
returns a category score, but Gatys instead take the outputs at
intermediate layers and construct L_content and L_style.</li>
<li>A figure showing off the algorithm.</li>
</ul></li>
<li>Additional technicalities: Introduce L-BFGS as a valid
quasi-Newton approach to solve the optimisation problem.</li>
</ul>

<h4 id="notebook-6-concrete-implementation-of-the-artistic-style-transfer-algorithm">Notebook 6: Concrete implementation of the artistic style transfer algorithm</h4>

<p>Since <a href="https://arxiv.org/abs/1508.06576">Gatys et al. (2015)</a> is a very
exciting paper, there exist many open source implementations of the
algorithm online. One of the most popular and general purpose ones is
by <a href="https://github.com/jcjohnson/neural-style">Justin Johnson and implemented in
Torch</a>. I’ve instead followed a <a href="https://github.com/fchollet/keras/blob/master/examples/neural_style_transfer.py">simple
example in Keras</a> and expanded into <a href="https://github.com/hnarayanan/artistic-style-transfer/blob/master/notebooks/6_Artistic_style_transfer_with_a_repurposed_VGG_Net_16.ipynb">a
fully-fledged notebook</a> that explains many details step by
step. I’ve reproduced it below in its entirety.</p>

<p>As always, we start with importing some packages we need. Note that we
don’t require too many packages.</p>

<pre><code class="language-python hljs"><span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> print_function

<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-keyword">from</span> keras <span class="hljs-keyword">import</span> backend
<span class="hljs-keyword">from</span> keras.models <span class="hljs-keyword">import</span> Model
<span class="hljs-keyword">from</span> keras.applications.vgg16 <span class="hljs-keyword">import</span> VGG16

<span class="hljs-keyword">from</span> scipy.optimize <span class="hljs-keyword">import</span> fmin_l_bfgs_b
<span class="hljs-keyword">from</span> scipy.misc <span class="hljs-keyword">import</span> imsave
</code></pre>

<pre><code class="hljs nginx"><span class="hljs-title">Using</span> TensorFlow backend.
</code></pre>

<h5 id="load-and-preprocess-the-content-and-style-images">Load and preprocess the content and style images</h5>

<p>Our first task is to load the content and style images. Note that the
content image we’re working with is not particularly high quality, but
the output we’ll arrive at the end of this process still looks really
good.</p>

<pre><code class="language-python hljs">height = <span class="hljs-number">512</span>
width = <span class="hljs-number">512</span>

content_image_path = <span class="hljs-string">'images/hugo.jpg'</span>
content_image = Image.open(content_image_path)
content_image = content_image.resize((width, height))
content_image
</code></pre>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/output_3_0.png" alt="">
  <figcaption></figcaption>
</figure>


<pre><code class="language-python hljs">style_image_path = <span class="hljs-string">'images/styles/wave.jpg'</span>
style_image = Image.open(style_image_path)
style_image = style_image.resize((width, height))
style_image
</code></pre>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/output_4_0.png" alt="">
  <figcaption></figcaption>
</figure>


<p>Then, we convert these images into a form suitable for numerical
processing. In particular, we add another dimension (beyond the
classic height x width x 3 dimensions) so that we can later
concatenate the representations of these two images into a common data
structure.</p>

<pre><code class="language-python hljs">content_array = np.asarray(content_image, dtype=<span class="hljs-string">'float32'</span>)
content_array = np.expand_dims(content_array, axis=<span class="hljs-number">0</span>)
print(content_array.shape)

style_array = np.asarray(style_image, dtype=<span class="hljs-string">'float32'</span>)
style_array = np.expand_dims(style_array, axis=<span class="hljs-number">0</span>)
print(style_array.shape)
</code></pre>

<pre><code class="hljs cpp">(<span class="hljs-number">1</span>, <span class="hljs-number">512</span>, <span class="hljs-number">512</span>, <span class="hljs-number">3</span>)
(<span class="hljs-number">1</span>, <span class="hljs-number">512</span>, <span class="hljs-number">512</span>, <span class="hljs-number">3</span>)
</code></pre>

<p>Before we proceed much further, we need to massage this input data to
match what was done in <a href="https://arxiv.org/abs/1409.1556">Simonyan and Zisserman
(2015)</a>, the paper that introduces the <em>VGG
Network</em> model that we’re going to use shortly.</p>

<p>For this, we need to perform two transformations:</p>

<ol>
<li>Subtract the mean RGB value (computed previously on the <a href="http://image-net.org/">ImageNet
training set</a> and easily obtainable from Google searches)
from each pixel.</li>

<li><p>Flip the ordering of the multi-dimensional array from <em>RGB</em> to
<em>BGR</em> (the ordering used in the paper).</p>

<pre><code class="language-python hljs">content_array[:, :, :, <span class="hljs-number">0</span>] -= <span class="hljs-number">103.939</span>
content_array[:, :, :, <span class="hljs-number">1</span>] -= <span class="hljs-number">116.779</span>
content_array[:, :, :, <span class="hljs-number">2</span>] -= <span class="hljs-number">123.68</span>
content_array = content_array[:, :, :, ::-<span class="hljs-number">1</span>]

style_array[:, :, :, <span class="hljs-number">0</span>] -= <span class="hljs-number">103.939</span>
style_array[:, :, :, <span class="hljs-number">1</span>] -= <span class="hljs-number">116.779</span>
style_array[:, :, :, <span class="hljs-number">2</span>] -= <span class="hljs-number">123.68</span>
style_array = style_array[:, :, :, ::-<span class="hljs-number">1</span>]
</code></pre></li>
</ol>

<p>Now we’re ready to use these arrays to define variables in Keras’
backend (the TensorFlow graph). We also introduce a placeholder
variable to store the <em>combination</em> image that retains the content of
the content image while incorporating the style of the style image.</p>

<pre><code class="language-python hljs">content_image = backend.variable(content_array)
style_image = backend.variable(style_array)
combination_image = backend.placeholder((<span class="hljs-number">1</span>, height, width, <span class="hljs-number">3</span>))
</code></pre>

<p>Finally, we concatenate all this image data into a single tensor
that’s suitable for processing by Keras’ VGG16 model.</p>

<pre><code class="language-python hljs">input_tensor = backend.concatenate([content_image,
                                    style_image,
                                    combination_image], axis=<span class="hljs-number">0</span>)
</code></pre>

<h5 id="reuse-a-model-pre-trained-for-image-classification-to-define-loss-functions">Reuse a model pre-trained for image classification to define loss functions</h5>

<p>The core idea introduced by <a href="https://arxiv.org/abs/1508.06576">Gatys et
al. (2015)</a> is that convolutional
neural networks (CNNs) pre-trained for image classification already
know how to encode perceptual and semantic information about
images. We’re going to follow their idea, and use the <em>feature spaces</em>
provided by one such model to independently work with content and
style of images.</p>

<p>The original paper uses the 19 layer VGG network model from <a href="https://arxiv.org/abs/1409.1556">Simonyan
and Zisserman (2015)</a>, but we’re
going to instead follow <a href="https://arxiv.org/abs/1603.08155">Johnson et
al. (2016)</a> and use the 16 layer
model (VGG16). There is no noticeable qualitative difference in making
this choice, and we gain a tiny bit in speed.</p>

<p>Also, since we’re not interested in the classification problem, we
don’t need the fully-connected layers or the final softmax
classifier. We only need the part of the model marked in green in the
table below.</p>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/vgg-architecture.png" alt="VGG Network Architectures.">
  <figcaption>VGG Network Architectures.</figcaption>
</figure>


<p>It is trivial for us to get access to this truncated model because
Keras comes with a set of pretrained models, including the VGG16 model
we’re interested in. Note that by setting <code>include_top=False</code> in the
code below, we don’t include any of the fully-connected layers.</p>

<pre><code class="language-python hljs">model = VGG16(input_tensor=input_tensor, weights=<span class="hljs-string">'imagenet'</span>,
              include_top=<span class="hljs-keyword">False</span>)
</code></pre>

<p>As is clear from the table above, the model we’re working with has a
lot of layers. Keras has its own names for these layers. Let’s make a
list of these names so that we can easily refer to individual layers
later.</p>

<pre><code class="language-python hljs">layers = dict([(layer.name, layer.output) <span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> model.layers])
layers
</code></pre>

<pre><code class="hljs bash">{<span class="hljs-string">'block1_conv1'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu:0'</span> shape=(<span class="hljs-number">3</span>, <span class="hljs-number">512</span>, <span class="hljs-number">512</span>, <span class="hljs-number">64</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block1_conv2'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_1:0'</span> shape=(<span class="hljs-number">3</span>, <span class="hljs-number">512</span>, <span class="hljs-number">512</span>, <span class="hljs-number">64</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block1_pool'</span>: &lt;tf.Tensor <span class="hljs-string">'MaxPool:0'</span> shape=(<span class="hljs-number">3</span>, <span class="hljs-number">256</span>, <span class="hljs-number">256</span>, <span class="hljs-number">64</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block2_conv1'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_2:0'</span> shape=(<span class="hljs-number">3</span>, <span class="hljs-number">256</span>, <span class="hljs-number">256</span>, <span class="hljs-number">128</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block2_conv2'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_3:0'</span> shape=(<span class="hljs-number">3</span>, <span class="hljs-number">256</span>, <span class="hljs-number">256</span>, <span class="hljs-number">128</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block2_pool'</span>: &lt;tf.Tensor <span class="hljs-string">'MaxPool_1:0'</span> shape=(<span class="hljs-number">3</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block3_conv1'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_4:0'</span> shape=(<span class="hljs-number">3</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">256</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block3_conv2'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_5:0'</span> shape=(<span class="hljs-number">3</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">256</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block3_conv3'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_6:0'</span> shape=(<span class="hljs-number">3</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">256</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block3_pool'</span>: &lt;tf.Tensor <span class="hljs-string">'MaxPool_2:0'</span> shape=(<span class="hljs-number">3</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">256</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block4_conv1'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_7:0'</span> shape=(<span class="hljs-number">3</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">512</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block4_conv2'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_8:0'</span> shape=(<span class="hljs-number">3</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">512</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block4_conv3'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_9:0'</span> shape=(<span class="hljs-number">3</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">512</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block4_pool'</span>: &lt;tf.Tensor <span class="hljs-string">'MaxPool_3:0'</span> shape=(<span class="hljs-number">3</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">512</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block5_conv1'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_10:0'</span> shape=(<span class="hljs-number">3</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">512</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block5_conv2'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_11:0'</span> shape=(<span class="hljs-number">3</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">512</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block5_conv3'</span>: &lt;tf.Tensor <span class="hljs-string">'Relu_12:0'</span> shape=(<span class="hljs-number">3</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">512</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'block5_pool'</span>: &lt;tf.Tensor <span class="hljs-string">'MaxPool_4:0'</span> shape=(<span class="hljs-number">3</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>, <span class="hljs-number">512</span>) dtype=<span class="hljs-built_in">float</span>32&gt;,
 <span class="hljs-string">'input_1'</span>: &lt;tf.Tensor <span class="hljs-string">'concat:0'</span> shape=(<span class="hljs-number">3</span>, <span class="hljs-number">512</span>, <span class="hljs-number">512</span>, <span class="hljs-number">3</span>) dtype=<span class="hljs-built_in">float</span>32&gt;}
</code></pre>

<p>If you stare at the list above, you’ll convince yourself that we
covered all items we wanted in the table (the cells marked in
green). Notice also that because we provided Keras with a concrete
input tensor, the various TensorFlow tensors get well-defined shapes.</p>

<hr>

<p>The crux of the paper we’re trying to reproduce is that the <a href="https://harishnarayanan.org/writing/artistic-style-transfer/">style
transfer problem can be posed as an optimisation
problem</a>,
where the loss function we want to minimise can be decomposed into
three distinct parts: the <em>content loss</em>, the <em>style loss</em> and the
<em>total variation loss</em>.</p>

<p>The relative importance of these terms are determined by a set of
scalar weights. These are  arbitrary, but the following set have been
chosen after quite a bit of experimentation to find a set that
generates output that’s aesthetically pleasing to me.</p>

<pre><code class="language-python hljs">content_weight = <span class="hljs-number">0.025</span>
style_weight = <span class="hljs-number">5.0</span>
total_variation_weight = <span class="hljs-number">1.0</span>
</code></pre>

<p>We’ll now use the feature spaces provided by specific layers of our
model to define these three loss functions. We begin by initialising
the total loss to 0 and adding to it in stages.</p>

<pre><code class="language-python hljs">loss = backend.variable(<span class="hljs-number">0.</span>)
</code></pre>

<h6 id="the-content-loss">The content loss</h6>

<p>For the content loss, we follow Johnson et al. (2016) and draw the
content feature from <code>block2_conv2</code>, because the original choice in
Gatys et al. (2015) (<code>block4_conv2</code>) loses too much structural
detail. And at least for faces, I find it more aesthetically pleasing
to closely retain the structure of the original content image.</p>

<p>This variation across layers is shown for a couple of examples in the
images below (just mentally replace <code>reluX_Y</code> with our Keras notation
<code>blockX_convY</code>).</p>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/content-feature.png" alt="Content feature reconstruction.">
  <figcaption>Content feature reconstruction.</figcaption>
</figure>


<p>The content loss is the (scaled, squared) Euclidean distance between
feature representations of the content and combination images.</p>

<pre><code class="language-python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">content_loss</span><span class="hljs-params">(content, combination)</span>:</span>
    <span class="hljs-keyword">return</span> backend.sum(backend.square(combination - content))

layer_features = layers[<span class="hljs-string">'block2_conv2'</span>]
content_image_features = layer_features[<span class="hljs-number">0</span>, :, :, :]
combination_features = layer_features[<span class="hljs-number">2</span>, :, :, :]

loss += content_weight * content_loss(content_image_features,
                                      combination_features)
</code></pre>

<h6 id="the-style-loss">The style loss</h6>

<p>This is where things start to get a bit intricate.</p>

<p>For the style loss, we first define something called a <em>Gram
matrix</em>. The terms of this matrix are proportional to the covariances
of corresponding sets of features, and thus captures information about
which features tend to activate together. By only capturing these
aggregate statistics across the image, they are blind to the specific
arrangement of objects inside the image. This is what allows them to
capture information about style independent of content. (This is not
trivial at all, and I refer you to <a href="https://arxiv.org/abs/1606.01286">a paper that attempts to explain
the idea</a>.)</p>

<p>TODO: Make some sort of note here about the fact that the Gram matrix
is a special case of a more general object. What we really want is
some measure (of local-ish statistics) that’s spatially invariant.</p>

<p>The Gram matrix can be computed efficiently by reshaping the feature
spaces suitably and taking an outer product.</p>

<pre><code class="language-python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gram_matrix</span><span class="hljs-params">(x)</span>:</span>
    features = backend.batch_flatten(backend.permute_dimensions(x, (<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)))
    gram = backend.dot(features, backend.transpose(features))
    <span class="hljs-keyword">return</span> gram
</code></pre>

<p>The style loss is then the (scaled, squared) Frobenius norm of the 
difference between the Gram matrices of the style and combination 
images.</p>

<p>Again, in the following code, I’ve chosen to go with the style
features from layers defined in Johnson et al. (2016) rather than
Gatys et al. (2015) because I find the end results more aesthetically
pleasing. I encourage you to experiment with these choices to see
varying results.</p>

<pre><code class="language-python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">style_loss</span><span class="hljs-params">(style, combination)</span>:</span>
    S = gram_matrix(style)
    C = gram_matrix(combination)
    channels = <span class="hljs-number">3</span>
    size = height * width
    <span class="hljs-keyword">return</span> backend.sum(backend.square(S - C)) / (<span class="hljs-number">4.</span> * (channels ** <span class="hljs-number">2</span>) * (size ** <span class="hljs-number">2</span>))

feature_layers = [<span class="hljs-string">'block1_conv2'</span>, <span class="hljs-string">'block2_conv2'</span>,
                  <span class="hljs-string">'block3_conv3'</span>, <span class="hljs-string">'block4_conv3'</span>,
                  <span class="hljs-string">'block5_conv3'</span>]
<span class="hljs-keyword">for</span> layer_name <span class="hljs-keyword">in</span> feature_layers:
    layer_features = layers[layer_name]
    style_features = layer_features[<span class="hljs-number">1</span>, :, :, :]
    combination_features = layer_features[<span class="hljs-number">2</span>, :, :, :]
    sl = style_loss(style_features, combination_features)
    loss += (style_weight / len(feature_layers)) * sl
</code></pre>

<h6 id="the-total-variation-loss">The total variation loss</h6>

<p>Now we’re back on simpler ground.</p>

<p>If you were to solve the optimisation problem with only the two loss
terms we’ve introduced so far (style and content), you’ll find that
the output is quite noisy. We thus add another term, called the <a href="https://arxiv.org/abs/1412.0035">total
variation loss</a> (a regularisation
term) that encourages spatial smoothness.</p>

<p>You can experiment with reducing the <code>total_variation_weight</code> and play
with the noise-level of the generated image.</p>

<pre><code class="language-python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">total_variation_loss</span><span class="hljs-params">(x)</span>:</span>
    a = backend.square(x[:, :height-<span class="hljs-number">1</span>, :width-<span class="hljs-number">1</span>, :] - x[:, <span class="hljs-number">1</span>:, :width-<span class="hljs-number">1</span>, :])
    b = backend.square(x[:, :height-<span class="hljs-number">1</span>, :width-<span class="hljs-number">1</span>, :] - x[:, :height-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>:, :])
    <span class="hljs-keyword">return</span> backend.sum(backend.pow(a + b, <span class="hljs-number">1.25</span>))

loss += total_variation_weight * total_variation_loss(combination_image)
</code></pre>

<h5 id="define-needed-gradients-and-solve-the-optimisation-problem">Define needed gradients and solve the optimisation problem</h5>

<p>The goal of this journey was to setup an optimisation problem that
aims to solve for a <em>combination image</em> that contains the content of
the content image, while having the style of the style image. Now that
we have our input images massaged and our loss function calculators in
place, all we have left to do is define gradients of the total loss
relative to the combination image, and use these gradients to
iteratively improve upon our combination image to minimise the loss.</p>

<p>We start by defining the gradients.</p>

<pre><code class="language-python hljs">grads = backend.gradients(loss, combination_image)
</code></pre>

<p>We then introduce an <code>Evaluator</code> class that computes loss and
gradients in one pass while retrieving them via two separate
functions, <code>loss</code> and <code>grads</code>. This is done because <code>scipy.optimize</code>
requires separate functions for loss and gradients, but computing them
separately would be inefficient.</p>

<pre><code class="language-python hljs">outputs = [loss]
outputs += grads
f_outputs = backend.function([combination_image], outputs)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">eval_loss_and_grads</span><span class="hljs-params">(x)</span>:</span>
    x = x.reshape((<span class="hljs-number">1</span>, height, width, <span class="hljs-number">3</span>))
    outs = f_outputs([x])
    loss_value = outs[<span class="hljs-number">0</span>]
    grad_values = outs[<span class="hljs-number">1</span>].flatten().astype(<span class="hljs-string">'float64'</span>)
    <span class="hljs-keyword">return</span> loss_value, grad_values

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Evaluator</span><span class="hljs-params">(object)</span>:</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.loss_value = <span class="hljs-keyword">None</span>
        self.grads_values = <span class="hljs-keyword">None</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">loss</span><span class="hljs-params">(self, x)</span>:</span>
        <span class="hljs-keyword">assert</span> self.loss_value <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span>
        loss_value, grad_values = eval_loss_and_grads(x)
        self.loss_value = loss_value
        self.grad_values = grad_values
        <span class="hljs-keyword">return</span> self.loss_value

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">grads</span><span class="hljs-params">(self, x)</span>:</span>
        <span class="hljs-keyword">assert</span> self.loss_value <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">None</span>
        grad_values = np.copy(self.grad_values)
        self.loss_value = <span class="hljs-keyword">None</span>
        self.grad_values = <span class="hljs-keyword">None</span>
        <span class="hljs-keyword">return</span> grad_values

evaluator = Evaluator()
</code></pre>

<p>Now we’re finally ready to solve our optimisation problem. This
combination image begins its life as a random collection of (valid)
pixels, and we use the
<a href="https://en.wikipedia.org/wiki/Limited-memory_BFGS">L-BFGS</a> algorithm
(a quasi-Newton algorithm that’s significantly quicker to converge
than standard gradient descent) to iteratively improve upon it.</p>

<p>We stop after 10 iterations because the output looks good to me and
the loss stops reducing significantly.</p>

<pre><code class="language-python hljs">x = np.random.uniform(<span class="hljs-number">0</span>, <span class="hljs-number">255</span>, (<span class="hljs-number">1</span>, height, width, <span class="hljs-number">3</span>)) - <span class="hljs-number">128.</span>

iterations = <span class="hljs-number">10</span>

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(iterations):
    print(<span class="hljs-string">'Start of iteration'</span>, i)
    start_time = time.time()
    x, min_val, info = fmin_l_bfgs_b(evaluator.loss, x.flatten(),
                                     fprime=evaluator.grads, maxfun=<span class="hljs-number">20</span>)
    print(<span class="hljs-string">'Current loss value:'</span>, min_val)
    end_time = time.time()
    print(<span class="hljs-string">'Iteration %d completed in %ds'</span> % (i, end_time - start_time))
</code></pre>

<pre><code class="hljs sql"><span class="hljs-operator"><span class="hljs-keyword">Start</span> <span class="hljs-keyword">of</span> iteration <span class="hljs-number">0</span>
<span class="hljs-keyword">Current</span> loss <span class="hljs-keyword">value</span>: <span class="hljs-number">8.10727e+10</span>
Iteration <span class="hljs-number">0</span> completed <span class="hljs-keyword">in</span> <span class="hljs-number">25</span>s
<span class="hljs-keyword">Start</span> <span class="hljs-keyword">of</span> iteration <span class="hljs-number">1</span>
<span class="hljs-keyword">Current</span> loss <span class="hljs-keyword">value</span>: <span class="hljs-number">5.51765e+10</span>
Iteration <span class="hljs-number">1</span> completed <span class="hljs-keyword">in</span> <span class="hljs-number">21</span>s
<span class="hljs-keyword">Start</span> <span class="hljs-keyword">of</span> iteration <span class="hljs-number">2</span>
<span class="hljs-keyword">Current</span> loss <span class="hljs-keyword">value</span>: <span class="hljs-number">4.37814e+10</span>
Iteration <span class="hljs-number">2</span> completed <span class="hljs-keyword">in</span> <span class="hljs-number">22</span>s
<span class="hljs-keyword">Start</span> <span class="hljs-keyword">of</span> iteration <span class="hljs-number">3</span>
<span class="hljs-keyword">Current</span> loss <span class="hljs-keyword">value</span>: <span class="hljs-number">3.97018e+10</span>
Iteration <span class="hljs-number">3</span> completed <span class="hljs-keyword">in</span> <span class="hljs-number">22</span>s
<span class="hljs-keyword">Start</span> <span class="hljs-keyword">of</span> iteration <span class="hljs-number">4</span>
<span class="hljs-keyword">Current</span> loss <span class="hljs-keyword">value</span>: <span class="hljs-number">3.80888e+10</span>
Iteration <span class="hljs-number">4</span> completed <span class="hljs-keyword">in</span> <span class="hljs-number">22</span>s
<span class="hljs-keyword">Start</span> <span class="hljs-keyword">of</span> iteration <span class="hljs-number">5</span>
<span class="hljs-keyword">Current</span> loss <span class="hljs-keyword">value</span>: <span class="hljs-number">3.71511e+10</span>
Iteration <span class="hljs-number">5</span> completed <span class="hljs-keyword">in</span> <span class="hljs-number">22</span>s
<span class="hljs-keyword">Start</span> <span class="hljs-keyword">of</span> iteration <span class="hljs-number">6</span>
<span class="hljs-keyword">Current</span> loss <span class="hljs-keyword">value</span>: <span class="hljs-number">3.65824e+10</span>
Iteration <span class="hljs-number">6</span> completed <span class="hljs-keyword">in</span> <span class="hljs-number">22</span>s
<span class="hljs-keyword">Start</span> <span class="hljs-keyword">of</span> iteration <span class="hljs-number">7</span>
<span class="hljs-keyword">Current</span> loss <span class="hljs-keyword">value</span>: <span class="hljs-number">3.61877e+10</span>
Iteration <span class="hljs-number">7</span> completed <span class="hljs-keyword">in</span> <span class="hljs-number">22</span>s
<span class="hljs-keyword">Start</span> <span class="hljs-keyword">of</span> iteration <span class="hljs-number">8</span>
<span class="hljs-keyword">Current</span> loss <span class="hljs-keyword">value</span>: <span class="hljs-number">3.59279e+10</span>
Iteration <span class="hljs-number">8</span> completed <span class="hljs-keyword">in</span> <span class="hljs-number">22</span>s
<span class="hljs-keyword">Start</span> <span class="hljs-keyword">of</span> iteration <span class="hljs-number">9</span>
<span class="hljs-keyword">Current</span> loss <span class="hljs-keyword">value</span>: <span class="hljs-number">3.57502e+10</span>
Iteration <span class="hljs-number">9</span> completed <span class="hljs-keyword">in</span> <span class="hljs-number">22</span>s
</span></code></pre>

<p>This process takes some time even on a machine with a discrete GPU, so
don’t be surprised if it takes a lot longer on a machine without one!</p>

<p>Note that we need to subject our output image to the inverse of the
transformation we did to our input images before it makes sense.</p>

<pre><code class="language-python hljs">x = x.reshape((height, width, <span class="hljs-number">3</span>))
x = x[:, :, ::-<span class="hljs-number">1</span>]
x[:, :, <span class="hljs-number">0</span>] += <span class="hljs-number">103.939</span>
x[:, :, <span class="hljs-number">1</span>] += <span class="hljs-number">116.779</span>
x[:, :, <span class="hljs-number">2</span>] += <span class="hljs-number">123.68</span>
x = np.clip(x, <span class="hljs-number">0</span>, <span class="hljs-number">255</span>).astype(<span class="hljs-string">'uint8'</span>)

Image.fromarray(x)
</code></pre>

<p>And instead of showing the output of the final iteration, I’ve made an
animated GIF of all iterations for you to enjoy.</p>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/style-transfer-iterations.gif" alt="Iteratively improving upon the combination image.">
  <figcaption>Iteratively improving upon the combination image.</figcaption>
</figure>


<h2 id="in-conclusion">In Conclusion</h2>

<p>Our road to the solution of the style transfer problem is a bit more
straightforward in hindsight. We started at a seemingly innocuous
place, the image classification problem. Before long, we realised that
the semantic gap between the input representation (raw pixels) and the
task at hand made it nearly impossible to write down a classifier as
an explicit program. So we turned to supervised learning, which is a
great tool for times like these when you have a problem that seems
intuitive to state — and you have lots of examples as to what you
intend — but where it’s hard to write down all the solution steps.</p>

<p>As we worked through more and more sophisticated supervised learning
solutions to the image classification problem, we found that deep
convolutional networks are really good at it. Not only that, we
understood that they perform so well because they’re great at learning
representations of the input data suitable to the task at hand. They
do this automatically without the need for <em>feature engineering</em>,
which would otherwise require a significant amount of domain
expertise. Furthermore, we realised that in studying the problem of
cat vs. baby deeply, what they’ve really learnt in a sense is <em>how to
see</em>. It is the internal representations of this knowledge that we
creatively repurposed to perform our style transfer!</p>

<p>Here are some beautiful examples generated by our style transfer code
over a range of styles.</p>

<div class="pure-g">
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/marilyn.jpg" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/block.jpg" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/edtaonisl.jpg" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/wave.jpg" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/c_hugo_bath_s_marilyn_cw_0.png" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/c_hugo_bath_s_block_cw_0.png" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/c_hugo_bath_s_gothic_cw_0.png" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/c_hugo_bath_s_wave_cw_0.png" alt="">
  </div>
</div>

<div class="pure-g" style="margin-bottom: 1em;">
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/forest.jpg" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/starry-night.jpg" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/picasso.jpg" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/scream.jpg" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/c_hugo_bath_s_forest_cw_0.png" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/c_hugo_bath_s_starry_night_cw_0.png" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/c_hugo_bath_s_picasso_cw_0.png" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/c_hugo_bath_s_scream_cw_0.png" alt="">
  </div>
</div>

<p>These results were mostly generated with the following weights for the
different loss terms: content weight <code>c_w</code> = 0.025, style weight <code>s_w</code>
= 5, and total variation weight <code>t_v_w</code> = 0.1. This choice came from a
lot of systematic experimentation across ranges for these
parameters. One of these experiments is captured in the following
animation that fixes the <code>c_w</code> = 0.025, <code>t_v_w</code> = 0.1 and varies <code>s_w</code>
between 0.1 and 10 in a few steps.</p>

<figure>
  <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/hyperparameter-search.gif" alt="Exploring a range of hyperparameters that systematically increasing the style loss.">
  <figcaption>Exploring a range of hyperparameters that systematically increasing the style loss.</figcaption>
</figure>


<p>As you can see above, there is an interesting balance to be had for
these different terms that allow us to control the emphasis of the
style relative to the content in the generated image.</p>

<p>And how do we do relative to Prisma?</p>

<div class="pure-g" style="margin-bottom: 1em;">
  <div class="pure-u-1-8">
    Style
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/edtaonisl.jpg" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/scream.jpg" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/wave.jpg" alt="">
  </div>
  <div class="pure-u-1-8">
  </div>
  <div class="pure-u-1-8">
    Prisma
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/IMG_2407.JPG" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/IMG_2408.JPG" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/IMG_2406.JPG" alt="">
  </div>
  <div class="pure-u-1-8">
  </div>
  <div class="pure-u-1-8">
    Ours
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/c_hugo_candy_s_gothic_cw_0.png" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/c_hugo_candy_s_scream_cw_0.png" alt="">
  </div>
  <div class="pure-u-1-4">
    <img class="pure-img" src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/c_hugo_candy_s_wave_cw_0.png" alt="">
  </div>
</div>

<p>Not bad I’d say! Prisma’s output is more visually pleasing to me on
the surface, but if you look carefully at the column corresponding to
<a href="https://en.wikipedia.org/wiki/The_Scream">Edvard Munch’s <em>The Scream</em></a> (the second column),
you’ll see that our code more faithfully reproduces the tone set in
the painting. Whether that’s an aesthetically pleasing choice or not I
leave up to you to decide!</p>

<p>In fact, much of these differences likely come down to subtle
differences in hyperparameter selection and potential
pre-/post-processing steps we may have missed. But the big way in
which our code is more problematic is that it takes <em>so long</em> to
generate the output. While Prisma takes a few seconds to generate
images, our code take tens (hundreds of seconds without a GPU) <em>per
iteration</em>. In order to solve this speed up this process, one could
follow a clever idea introduced in <a href="https://arxiv.org/abs/1603.08155">Johnson et
al. (2016)</a>. There, instead of
solving the expensive style transfer optimisation problem, they train
another convnet to approximate solutions to it giving them a 1000x
speedup!</p>

<p>I’m working on implementing this idea as part of am open source
<a href="https://github.com/hnarayanan/stylist">webapp called <em>Stylist</em></a>. Feel free to
join me if you’d like to help!</p>

<p>And as we reach the end of this story, you’ve probably gathered
that this whole <em>quest to reproduce Prisma’s visual effect</em> was simply
a ruse to get you to trudge through all this background on deep
learning for computer vision. But now that you’ve made it to the other
side, congratulations! You now not only know how to solve the style
transfer problem and generate beautiful results, but you’re also in a
position to read, understand and reproduce state-of-the-art research
in the field of convolutional neural networks. This is a pretty big
deal, so spend some time celebrating this and give yourself a big pat
on the back.</p>

<h2 id="selected-references-and-further-reading">Selected references and further reading</h2>

<ol>
<li><a href="https://github.com/hnarayanan/artistic-style-transfer">Accompanying IPython notebooks on GitHub</a></li>
<li><a href="http://cs231n.stanford.edu/">The Stanford course on Convolutional Neural
Networks</a> and <a href="http://cs231n.github.io/">accompanying notes</a></li>
<li><a href="http://www.deeplearningbook.org/">Deep Learning Book</a></li>
<li><a href="http://yosinski.com/deepvis">Deep Visualization Toolbox</a></li>
<li><a href="https://arxiv.org/abs/1508.06576">A Neural Algorithm of Artistic Style</a>,
the seminal article</li>
<li><a href="https://arxiv.org/abs/1409.1556">Very Deep Convolutional Networks for Large-Scale Image
Recognition</a></li>
<li><a href="https://arxiv.org/abs/1603.08155">Perceptual Real-Time Style
Transfer</a> and <a href="https://cs.stanford.edu/people/jcjohns/papers/fast-style/fast-style-supp.pdf">supplementary
material</a></li>
<li>TensorFlow Website: MNIST digit classification tutorial <a href="https://www.tensorflow.org/get_started/mnist/beginners">for
beginners</a> and <a href="https://www.tensorflow.org/get_started/mnist/pros">for
experts</a>, <a href="https://www.tensorflow.org/tutorials/deep_cnn">Deep
CNNs</a>, <a href="http://playground.tensorflow.org/">playground</a></li>
<li><a href="https://blog.keras.io/keras-as-a-simplified-interface-to-tensorflow-tutorial.html">Keras as a simplified interface to TensorFlow</a></li>
</ol>

  </section>

  
  <footer class="post-footer">
    <section class="share">
      <h4>Enjoyed this article?</h4>
      <p>Return to my <a href="https://harishnarayanan.org/writing/">article collection</a> to find more fun stuff to read. And <a href="https://twitter.com/copingbear">follow me on Twitter</a> or <a href="https://harishnarayanan.org/index.xml">subscribe to the RSS feed</a> to keep up-to-date with new writing!</p>
    </section>
  </footer>

</article>
</div>

    </main>

    <footer class="mainfooter">
      <div class="container">
        <p>© 2021 <a href="mailto:mail@harishnarayanan.org">Harish Narayanan</a> — <a href="https://twitter.com/copingbear">Twitter</a> · <a href="https://github.com/hnarayanan">GitHub</a> · <a href="https://harishnarayanan.org/index.xml">RSS</a></p>
      </div>
    </footer>
    
    <script src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/highlight.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script type="text/x-mathjax-config;executed=true">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});</script>
    <script src="Convolutional%20neural%20networks%20for%20artistic%20style%20transfer_files/MathJax.js"></script>

  


<div style="position: absolute; width: 0px; height: 0px; overflow: hidden; padding: 0px; border: 0px none; margin: 0px;"><div id="MathJax_Font_Test" style="position: absolute; visibility: hidden; top: 0px; left: 0px; width: auto; padding: 0px; border: 0px none; margin: 0px; white-space: nowrap; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; font-size: 40px; font-weight: normal; font-style: normal; font-size-adjust: none; font-family: MathJax_Size2, sans-serif;"></div></div></body></html>